'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[15],{1214:function(t,C,a){var c=a(10);t=a(0);var b=a(15),d=a(691),f=a(50),e=a(37),k=a(1274),l=a(235),m=a(21),v=a(245),n=a(258),w=a(12),r=a(90),u=a(1);class y extends l.a{constructor(F){super(document.createElement("div"));this.asj=U=>{this.gk=U};this.$=F;this.grid=m.g(F)}static init(F){y.Ma?b.ULS.sendTraceTag(522782307,1,15,"FormulaSuggestionUIControl.init: unexpected call after already being inited."):y.Ma=new y(F)}static instance(){return y.Ma}get kf(){return null!=
this.gk}get $d(){return v.a.KTe}get mc(){return this.gk}hg(F,U){U||w.DOMElementExtensions.setFocus(this.mc);return!U}kh(F){if(null!=this.mc)return w.DOMElementExtensions.vf(this.mc,F);b.ULS.sendTraceTag(526197124,1,50,"FormulaSuggestionUIControl.belongsToSection: card rootElement should not be null.");return!1}lj(){}Nj(){}show(F,U,X,S,H,D=null,J=null,M=null){if(!J&&this.$){J=this.grid.Vb(M);if(!J){b.ULS.sendTraceTag(537161875,1,50,"FormulaSuggestionUIControl.Show: failed to show UI, formattedActiveCell is null.");
return}if(!J.cell.Dk){b.ULS.sendTraceTag(537161874,1,50,"FormulaSuggestionUIControl.Show: failed to show UI, formattedActiveCell is not in view.");return}J=this.grid.getCellBounds(J.cell,!0);b.ULS.shipAssertTag(537161873,1,!!J,"FormulaSuggestionUIControl.Show: target cell bounds should not be null.")}b.ULS.sendTraceTag(537161872,1,50,"FormulaSuggestionUIControl.Show: calling AppChrome API to render card UI.");n.a(this.$).Xh(this);appChrome.renderFormulaSuggestionCard(F,U,this.domElement,J.y,J.x,J.y+
J.height,J.x+J.width,X,S,H,D,this.asj)}hide(){b.ULS.sendTraceTag(537161871,1,50,"FormulaSuggestionUIControl.Hide: calling AppChrome API to unmount card UI.");n.a(this.$).Nz(this);appChrome.unmountReactComponent(this.domElement)}uda(F,U,X){u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.FBECurtainLifterCalloutForTestingOnlyEnabled",!1)&&(this.A0a&&F.equals(this.Lpi)||(this.A0a&&document.body.removeChild(this.A0a),this.Lpi=F,F=this.grid.Vb(F),F=this.grid.getCellBounds(F.cell,!0),this.A0a=
document.createElement("div"),this.A0a.setAttribute("style",`position:fixed;
        left: ${F.x+F.width}px;
        top: ${F.y+F.height/2}px`),document.body.appendChild(this.A0a)),F=new r.a(-847286761,0,this.$.Mc,0,null),this.$.Ka.Mb(F,{["CalloutName"]:15,["Target"]:this.A0a,["NewState"]:U,["Reason"]:X}))}}Object(t.a)(y,"FormulaSuggestionUIControl",l.a,[722,102]);class x extends d.a{constructor(F){super(F)}yd(){b.ULS.sendTraceTag(528758224,0,50,"FormulaByExampleCommandHandlerFactory.CreateCommandHandlersAsync: FormulaByExampleCommandHandler init flow started.");const F=f.GetServiceTaskFactory.Ra(this.$.da,
453,454,1),U=f.GetServiceTaskFactory.Ra(this.$.da,266,265,1);e.TaskExtensions.Aa(e.TaskExtensions.Wd([F,U],this.la),()=>{const X=this.$.da.za(328);this.gd([new k.a(this.$,X,U.result,F.result,y.instance())]);b.ULS.sendTraceTag(537161924,0,50,"FormulaByExampleCommandHandlerFactory.CreateCommandHandlersAsync: FormulaByExampleCommandHandler initialized successfully")},this.la)}static ka(F){d.a.Nd(455,new x(F))}}Object(t.a)(x,"FormulaByExampleCommandHandlerFactory",d.a,[]);var B=a(55);l=a(221);var z=a(931);
class A extends l.a{constructor(F){super();this.$=F;this.Fb()}create(){b.ULS.sendTraceTag(528758214,0,50,"FormulaByExampleManagerFactory.Create: starting service creation flow.");const F=f.GetServiceTaskFactory.Ra(this.$.da,328,327,1),U=f.GetServiceTaskFactory.Ra(this.$.da,266,265,1),X=u.EwaSettings.isChangeGateEnabled("OfficeVSO:6327953_FormatOutputResultsOfFBEDeprecated")?B.Task.Ta(null):f.GetServiceTaskFactory.create(this.$.da,18,this.$.la,1),S=[F,U,X];y.init(this.$);e.TaskExtensions.Aa(e.TaskExtensions.Wd(S,
this.la),()=>{b.ULS.sendTraceTag(528758213,0,50,"FormulaByExampleManagerFactory.Create: augmentationLoopManager and calcManager creation tasks resolved.");const H=new z.a(this.$,F.result,U.result,X.result,y.instance());this.qb(this.$.da.za(453)||this.$.da.Ga(453,H));b.ULS.sendTraceTag(537161882,0,50,"FormulaByExampleManagerFactory.Create: FormulaByExampleManager initialized successfully")},this.la)}static ka(F){F.da.Ga(454,new A(F))}}Object(t.a)(A,"FormulaByExampleManagerFactory",l.a,[]);a.d(C,"a",
function(){return I});const I=()=>{c.a.Fa(F=>{A.ka(F);x.ka(F)})}},1274:function(t,C,a){t=a(0);var c=a(7),b=a(15),d=a(24),f=a(33),e=a(162),k=a(182),l=a(21),m=a(864),v=a(695);class n extends m.a{constructor(){super();this.formulasCount=this.columnNames=this.additionalInputs=this.examples=null;this.invocationMethod=this.stateID=0;this.guid=this.supportedFunctions=null;this.H_=Object.assign(new v.a,{T_:n.getTypeName(),B_:n.Pd()})}static getTypeName(){return"AugLoop_FormulaByExample_FormulaByExampleSignal"}static Pd(){return["AugLoop_Signals_Signal"]}}
Object(t.a)(n,"FormulaByExampleSignal",m.a,[]);var w=a(1282),r=a(55),u=a(814),y=a(931),x=a(1),B=a(455),z=a(848);a.d(C,"b",function(){return A});a.d(C,"a",function(){return I});const A={C6c:"editRange",YVd:"triggerKind",NSe:"flowId",jdf:"isInTable"};class I{constructor(F,U,X,S,H){this.CB=!1;this.$=F;this.gridView=l.g(F);this.augmentationLoopManager=U;this.calcManager=X;this.formulaByExampleManager=S;this.VJ=H;this.Nn=z.a.getInstance(this.$);this.CB=Object(u.b)(this.$);this.Yyi=x.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.FormulaByExampleMaximalNumberOfAdditionalInputRows",
30);b.ULS.sendTraceTag(528758226,306,50,"FormulaByExampleCommandHandler.ctor: FBE command handler created")}Nc(){return!1}executeCommand(F,U,X){F=!1;U=U.command;switch(U){case 1928326585:F=X&&X[A.YVd]?X[A.YVd]:0;const S=X[A.NSe];if(0===F)return b.ULS.sendTraceTag(524940245,306,15,"FormulaByExampleManager.executeCommand: triggerFormulaByExample command called for execution with NoTrigger value."),this.Nn.kt(S,1),r.Task.Ta(!0);const H=!X||!X[A.C6c],D=this.wMh(X,H);X=!X||X[A.jdf];H||2!==F&&!f.a.R5a(this.$)||
this.formulaByExampleManager.XSi(D,S,X);F=this.triggerFormulaByExample(D,H,S,X)}return F?r.Task.Ta(!0):k.a(U)}Cc(F,U){switch(U.command){case 1928326585:return f.a.ifc(this.$);default:return!1}}Rc(){return!1}wMh(F,U){b.ULS.sendTraceTag(537161928,306,50,`FormulaByExampleCommandHandler.getEditedRange: flow triggered from: ${U?"Ribbon":"AutoDetect"}`);return U?this.gridView.ha.sa.activeCell:F[A.C6c]}triggerFormulaByExample(F,U,X,S){if(!this.augmentationLoopManager)return b.ULS.sendTraceTag(537161927,
306,10,"FormulaByExampleCommandHandler.TriggerFormulaByExample: augmentationLoopManager instance is null"),this.Nn.kt(X,13,{reason:"AugmentationLoopManager instance is null"}),!1;if(S){const H=this.gridView.Db.Yj(F,!1);if(!H)return b.ULS.sendTraceTag(537161925,306,15,"FormulaByExampleCommandHandler.TriggerFormulaByExample: table returned null for given edit range."),this.Nn.kt(X,13,{reason:"Table returned null for given edit range"}),!1;S=f.a.R5a(this.$)&&!f.a.f4(this.$);U=this.cOh(F,U,H,X,S)}else U=
this.bOh(F,X);if(!U)return this.Nn.kt(X,13,{reason:"Signal is null"}),!0;b.ULS.sendTraceTag(537161926,306,50,`FormulaByExampleCommandHandler.TriggerFormulaByExample: calling SubmitOperationSignal for flowId: ${X}.`);this.augmentationLoopManager.pTd(U);this.Nn.kt(X,12);this.VJ.uda(F,1);this.CB&&Object(u.f)("SIGNALSENT",X);return!0}cOh(F,U,X,S,H){const {examples:D,additionalInputs:J}=this.BIh(X,F);if(!D||0==D.length)return b.ULS.sendTraceTag(527496675,306,50,"FormulaByExampleCommandHandler.getFormulaByExampleSignalFromTable: column does not have any examples or any examples with inputs"),
null;F=this.RJh(X);if(!F)return null;U=Object(c.a)(new n,{formulasCount:1,examples:D,additionalInputs:J,columnNames:F,stateID:this.$.ea.E7a,invocationMethod:U?0:1,guid:S.toString(),supportedFunctions:{TEXTSPLIT:H,TEXTSLICE:H,FINDN:H,TEXTAFTER:H,TEXTBEFORE:H}});b.ULS.sendTraceTag(528758225,306,50,"FormulaByExampleCommandHandler.getFormulaByExampleSignalFromTable: signal generated.");return U}BIh(F,U){F=e.a(F);return this.LVe(F,U.left)}RJh(F){const U=[],X=F.name;var S=e.a(F);F=this.calcManager.W3a(F);
if(S&&F){S=S.left;for(let H of F)U.push({column:S,name:X+"[@["+H+"]]"}),S++;return U}b.ULS.sendTraceTag(524940244,306,15,`FormulaByExampleCommandHandler.getColumnNamesMapFromTable: failed to generate columnNames. is tableRange null: ${!S}, is colNamesCurrentTable null: ${!F}`);return null}bOh(F,U){var X=new d.Range(F.top-y.a.NEe,F.left-y.a.wah,F.bottom,F.right,!0,!0);F=this.LVe(X,F.left).examples;if(!F||0==F.length)return b.ULS.sendTraceTag(524940243,306,50,"FormulaByExampleCommandHandler.getFormulaByExampleSignalFromRange: column does not have any examples or any examples with inputs"),
null;X=this.QJh(X);U=Object(c.a)(new n,{formulasCount:1,examples:F,columnNames:X,stateID:this.$.ea.E7a,invocationMethod:1,guid:U.toString(),supportedFunctions:{TEXTSPLIT:!0,TEXTSLICE:!0,FINDN:!0,TEXTAFTER:!0,TEXTBEFORE:!0}});b.ULS.sendTraceTag(524940242,306,50,"FormulaByExampleCommandHandler.getFormulaByExampleSignalFromRange: signal generated.");return U}LVe(F,U){const X=[],S=[],H=this.gridView.mk("FormulaByExample.GetSignalExamplesFromTable",F);try{const D=F.right;F=!1;let J=[],M=null;for(;H.$$mn();){const G=
H.$$cu(),T=G.range.left;T===U?G.text&&(M=this.TBe(G)):(G.text&&(F=!0),J.push(this.TBe(G)));T===D&&(F&&(M?X.push({output:M,inputs:J}):S.length<this.Yyi&&S.push({output:null,inputs:J})),J=[],M=null,F=!1)}}finally{H&&H.dispose()}return{examples:X,additionalInputs:S}}QJh(F){const U=[];for(let X=F.left;X<=F.right;X++){const S={column:X,name:d.Range.xP(X)};U.push(S)}return U}TBe(F){let U;if(1===F.Sw.type){U=parseFloat(F.Sw.value);var X=this.calcManager.jac(F.cell.Gk);Object(B.c)(X)?X=X.value.isDate?4:X.value.isTime?
5:1:(b.ULS.sendTraceTag(522840207,0,10,`FormulaByExampleCommandHandler.createAugLoopCell: CalcManager's getNumberFormat method failed on the given cell, falling back to number format. failureReason: ${X.reason}`),X=1)}else U=F.text,X=0;return Object.assign(new w.a,{row:F.range.top,column:F.range.left,displayText:F.text,rawValueJson:JSON.stringify(U),numberFormatCategory:X.toString()})}}Object(t.a)(I,"FormulaByExampleCommandHandler",null,[195])},1310:function(t,C,a){a.r(C);a.d(C,"FormulaByExampleAutoSuggestActor",
function(){return u});t=a(0);var c=a(15),b=a(24),d=a(162),f=a(931),e=a(90),k=a(21),l=a(814),m=a(1274),v=a(33),n=a(972),w=a(848),r=a(1);class u{constructor(y,x,B){this.CB=!1;this.cOa=(z,A)=>{if(A.Rpb){z=A.Ck;var I=this.gridView.Db.XLa(z);if(I||v.a.R5a(this.$)){if(r.EwaSettings.isChangeGateEnabled("OfficeVSO:7041480_FormulaByExampleFlowAggregatorFixed")&&I){const F=this.gridView.Db.Yj(z,!1);this.Nn.VBf(F.name,z.left-(F.displayRtl?F.usedRange.right:F.usedRange.left),z.top-F.usedRange.top)}switch(this.MYh(A,
I)){case 0:this.PAb=null;this.Nn.kt(w.b,1);break;default:I&&(this.Nn.kt(w.b,3),this.PAb=A.Ck,this.rsd||(this.calcManager.gEg(this.OCf),this.rsd=!0))}}else this.PAb=null}else this.PAb=null};this.OCf=(z,A)=>{A.Ck.equals(this.PAb)?(this.triggerFormulaByExample(2,!0,this.PAb),this.calcManager.taj(this.OCf),this.rsd=!1):this.Nn.kt(w.b,2)};this.$=y;this.gridView=k.g(y);this.calcManager=x;this.CB=B;this.rsd=!1;this.gridView.Xb.em(this.cOa);this.Nn=w.a.getInstance(y)}triggerFormulaByExample(y,x,B){const z=
this.Nn.ZZe();c.ULS.sendTraceTag(537161929,306,50,`FormulaByExampleAutoSuggestActor.OnEndEdit: triggering FormulaByExample for cell edit. Trigger kind: ${y}, FlowId: ${z}`);this.CB&&Object(l.f)("EDITCOMMIT",z);const A=new e.a(1928326585,1,2,6,null);this.$.Ka.Mb(A,{[m.b.C6c]:B,[m.b.YVd]:y,[m.b.NSe]:z,[m.b.jdf]:x})}MYh(y,x){const B=y.Ck,z=this.gridView.Vb(B);if(!z)return c.ULS.sendTraceTag(524120778,306,15,`FormulaByExampleAutoSuggestActor.getTriggerKindForInput: formattedCell is null. investigation hints: is editRange null = ${!B}`),
0;y=this.calcManager.chi(z.cell.Gk,y.cpb);return null===y||y?0:x?this.gridView.Db.cff(B)?0:this.Ekj(B):this.Dkj(B)}Ekj(y){var x=this.gridView.Db.Yj(y,!1);x=d.a(x);y=y.left;y=new b.Range(x.top,y,x.bottom,y,!0,!0);return this.iWf(y,"FormulaByExampleAutoSuggestActor:Table")}Dkj(y){const x=y.left;y=new b.Range(y.top-f.a.NEe,x,y.bottom,x,!0,!0);return this.iWf(y,"FormulaByExampleAutoSuggestActor:Range")}iWf(y,x){var B;let z=new Set,A=0;y=this.gridView.mk(x,y);try{for(;y.$$mn();){const I=y.$$cu();if(null===
(B=I.Sw)||void 0===B?0:B.value)if(z.add(I.Sw.value),A++,z.size>=n.a)return 2}}finally{y&&y.dispose()}A>=n.a&&c.ULS.sendTraceTag(523368219,306,50,"FormulaByExampleAutoSuggestActor.searchForSufficientExamplesInOutputColumn: Table has sufficient example amount - but not enough distinct examples.");return 0}}Object(t.a)(u,"FormulaByExampleAutoSuggestActor",null,[])},1428:function(t,C,a){function c(na){return void 0===na?"undefined":`${null===na||void 0===na?void 0:na.Xluid}/${null===na||void 0===na?void 0:
na.Xrevid}@${null===na||void 0===na?void 0:na.DocId}`}a.r(C);t=a(0);var b=a(7),d=a(15),f=a(98);C=a(221);class e{}Object(t.a)(e,"WorkbookCoauthVersion",null,[]);var k=a(38);class l{constructor(){this.stateId=0;this.FYd=null}}Object(t.a)(l,"StateIdChangedInfo",null,[]);var m=a(61);const v=(na,Na,Va,Sa,vb,Oa,yb=null)=>{yb=na.Na(1,yb);yb.isObserverRequired=Na;return m.g(na,"ObserverRequiredNotification",yb,Va,Sa,vb,Oa,0)};class n extends Sys.EventArgs{constructor(na,Na,Va,Sa){super();this.rJ=na;this.parentPath=
Va;this.operationType=Sa}}Object(t.a)(n,"AnnotationReceivedEventArgs",Sys.EventArgs,[]);var w=a(28),r=a(118),u=a(1);class y{constructor(){this.stateUpdateHandler=this.handler=this.config=this.annotationType=null}}Object(t.a)(y,"ActivateAnnotationParameters",null,[]);class x{constructor(){this.supportCustomMessages=this.accessTokenTTL=this.accessToken=this.collabStateId=this.userListVersion=this.configurations=this.permissionFlags=this.serverEventVersion=this.metadataVersion=this.ecsOperationUrl=this.ecsRestUrl=
this.ecsSessionId=this.wacCluster=null}}Object(t.a)(x,"ExcelServerParameters",null,[]);class B{constructor(){this.excelServerParameters=null}}Object(t.a)(B,"ForceReconnectParameters",null,[]);class z{constructor(){this.workflow=null}}Object(t.a)(z,"RegisterLocalWorkflowParameters",null,[]);class A{constructor(){this.handler=null}}Object(t.a)(A,"SetAnnotationResultCallbackParameters",null,[]);class I{constructor(){this.message=null}}Object(t.a)(I,"SubmitCustomMessageParameters",null,[]);class F{constructor(){this.operation=
null}}Object(t.a)(F,"SubmitOperationParameters",null,[]);var U=a(721),X=a(969),S=a(749),H=a(695);class D extends S.a{constructor(){super();this.H_=Object.assign(new H.a,{T_:D.getTypeName(),B_:D.Pd()})}static getTypeName(){return"AugLoop_Core_DeleteOperation"}static Pd(){return["AugLoop_Core_Operation"]}}Object(t.a)(D,"DeleteOperation",S.a,[]);class J extends S.a{constructor(){super();this.isFocused=!1;this.H_=Object.assign(new H.a,{T_:J.getTypeName(),B_:J.Pd()})}static getTypeName(){return"AugLoop_Core_FocusOperation"}static Pd(){return["AugLoop_Core_Operation"]}}
Object(t.a)(J,"FocusOperation",S.a,[]);var M=a(863),G=a(970);class T extends G.a{constructor(){super();this.prevParentPath=null;this.H_=Object.assign(new H.a,{T_:T.getTypeName(),B_:T.Pd()})}static getTypeName(){return"AugLoop_Core_MoveOperation"}static Pd(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}}Object(t.a)(T,"MoveOperation",G.a,[]);var K=a(968);class L extends S.a{constructor(){super();this.M_=null;this.H_=Object.assign(new H.a,{T_:L.getTypeName(),B_:L.Pd()})}static getTypeName(){return"AugLoop_Core_UpdateAnnotationMetaDataOperation"}static Pd(){return["AugLoop_Core_Operation"]}}
Object(t.a)(L,"UpdateAnnotationMetaDataOperation",S.a,[]);var V=a(971);class W extends S.a{constructor(){super();this.isVisible=!1;this.H_=Object.assign(new H.a,{T_:W.getTypeName(),B_:W.Pd()})}static getTypeName(){return"AugLoop_Core_VisibilityOperation"}static Pd(){return["AugLoop_Core_Operation"]}}Object(t.a)(W,"VisibilityOperation",S.a,[]);var da=a(716);class qa extends da.a{constructor(){super();this.bridgeId=this.cv=this.messageId=null;this.H_=Object.assign(new H.a,{T_:qa.getTypeName(),B_:qa.Pd()})}static getTypeName(){return"AugLoop_Session_Protocol_Message"}static Pd(){return[]}}
Object(t.a)(qa,"Message",da.a,[]);class O extends qa{constructor(){super();this.H_=Object.assign(new H.a,{T_:O.getTypeName(),B_:O.Pd()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelKeepAlive"}static Pd(){return["AugLoop_Session_Protocol_Message"]}}Object(t.a)(O,"ExcelKeepAlive",qa,[]);class ea extends U.a{constructor(){super();this.isObserverRequired=this.isSeedingRequired=!1;this.H_=Object.assign(new H.a,{T_:ea.getTypeName(),B_:ea.Pd()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ObserverStatusAnnotation"}static Pd(){return["AugLoop_Core_Annotation"]}}
Object(t.a)(ea,"ObserverStatusAnnotation",U.a,[]);class R extends qa{constructor(){super();this.parentPath=this.opType=this.seq=this.item=null;this.H_=Object.assign(new H.a,{T_:R.getTypeName(),B_:R.Pd()})}static getTypeName(){return"AugLoop_Session_Protocol_MicroSyncMessage"}static Pd(){return["AugLoop_Session_Protocol_Message"]}}Object(t.a)(R,"MicroSyncMessage",qa,[]);class oa extends da.a{constructor(){super();this.id=null;this.sizeBytes=0;this.dataPointer=this.data=null;this.H_=Object.assign(new H.a,
{T_:oa.getTypeName(),B_:oa.Pd()})}static getTypeName(){return"AugLoop_Core_Blob"}static Pd(){return[]}}Object(t.a)(oa,"Blob",da.a,[]);class pa extends oa{constructor(){super();this.format=0;this.otherFormat=null;this.size=0;this.isOriginalSize=null;this.H_=Object.assign(new H.a,{T_:pa.getTypeName(),B_:pa.Pd()})}static getTypeName(){return"AugLoop_Image_ImageContent"}static Pd(){return["AugLoop_Core_Blob"]}}Object(t.a)(pa,"ImageContent",oa,[]);class Pa extends da.a{constructor(){super();this.heightPx=
this.widthPx=0;this.H_=Object.assign(new H.a,{T_:Pa.getTypeName(),B_:Pa.Pd()})}static getTypeName(){return"AugLoop_Image_ImageTileMetadata"}static Pd(){return[]}}Object(t.a)(Pa,"ImageTileMetadata",da.a,[]);class Z extends Pa{constructor(){super();this.contents=null;this.H_=Object.assign(new H.a,{T_:Z.getTypeName(),B_:Z.Pd()})}static getTypeName(){return"AugLoop_Image_ImageTile"}static Pd(){return["AugLoop_Image_ImageTileMetadata"]}}Object(t.a)(Z,"ImageTile",Pa,[]);var Ra=a(99);class Ga{constructor(){this.annotations=
new Set}zoj(na){this.AJ=na;return this}activateAnnotation(na){if(this.annotations.has(na))throw na=`Annotation from type ${na.annotationType} was already activated`,d.ULS.sendTraceTag(521216417,0,10,`AugmentationLoopFeatureRegistrationInfoBuilder.activateAnnotation: ${na}`),Error(na);this.annotations.add(na);return this}zpj(){this.featureName="FormulaByExample";return this}build(){if(void 0===this.AJ)throw d.ULS.sendTraceTag(521216416,0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: Close callback is not set"),
Error("Close callback is not set");if(0===this.annotations.size)throw d.ULS.sendTraceTag(521216415,0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: No annotations were activated"),Error("No annotations were activated");if(!this.featureName)throw d.ULS.sendTraceTag(521216414,0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: Feature Name is not set"),Error("Feature Name is not set");return{featureName:this.featureName,AJ:this.AJ,annotations:this.annotations}}}Object(t.a)(Ga,"AugmentationLoopFeatureRegistrationInfoBuilder",
null,[842]);class Ba extends k.a{constructor(na,Na,Va,Sa=null){var vb;super();this.Jla=null;this.isObserverRequired=!1;this.jf=null;this.EXa=[];this.pSc=new Set;this.tlc=[];this.slc=new Map;this.lZb=[];this.Zvh=new Map([[1,1],[2,2],[3,3]]);this.iCc=new e;this.Xc=(Oa,yb)=>{yb.EH&&this.$.ea.sessionId&&(d.ULS.sendTraceTag(537170394,0,50,`AugmentationLoopManager.onSessionIdChanged: Update augmentation loop server on new ECS Session ID: '${this.$.ea.sessionId}'`),this.iT.forceReconnectSession(Object(b.a)(new B,
{excelServerParameters:Object(b.a)(new x,{wacCluster:this.$.ya.MachineCluster,ecsSessionId:this.$.ea.sessionId,ecsRestUrl:this.$.ya.RestActionUrl,ecsOperationUrl:"",metadataVersion:0,serverEventVersion:0,permissionFlags:0,configurations:0,userListVersion:0,collabStateId:0,accessToken:this.$.ya.AccessToken,accessTokenTTL:this.$.ya.AccessTokenValidTo.toString()})})).catch(Ob=>{d.ULS.sendTraceTag(526406272,0,50,`AugmentationLoopManager.onSessionIdChanged: forceReconnectSession promise rejected with error ${Ob}`)}),
d.ULS.sendTraceTag(528348225,0,50,`AugmentationLoopManager.onSessionIdChanged: sending ObserverRequiredNotification, isSeedingRequired: ${this.isObserverRequired}`),this.juc(this.isObserverRequired))};this.Hlc=(Oa,yb)=>{d.ULS.sendTraceTag(520679431,0,50,"AugmentationLoopManager.onCloseMessage called");if(Oa){this.iT.startNewSession();for(const Ob of this.EXa)this.BXa(Ob)}else this.EXa.some(Ob=>!Ob.Vyb)||this.Kxc(),Oa=this.Yvh(yb),this.Nue(Oa),this.pYc(),3===Oa&&(this.iT.startNewSession(),this.EXa.filter(Ob=>
!Ob.Vyb).forEach(Ob=>this.BXa(Ob))),u.EwaSettings.isChangeGateEnabled("OfficeVSO:5948479_QuickSavesWhenAloneForAugloop")&&this.$.ea.sessionId&&(d.ULS.sendTraceTag(520679430,0,50,"AugmentationLoopManager.onCloseMessage: sending ObserverRequiredNotification, isSeedingRequired: false"),this.juc(!1))};this.OPi=()=>{d.ULS.sendTraceTag(537170393,0,50,"AugmentationLoopManager.onRetryableCloseMessage called");for(let Oa of this.pSc)this.activateAnnotation(Oa)};this.$Ni=()=>{d.ULS.sendTraceTag(537170392,0,
50,"AugmentationLoopManager.onNonRetryableCloseMessage called");this.Kxc();this.pYc();u.EwaSettings.isChangeGateEnabled("OfficeVSO:5948479_QuickSavesWhenAloneForAugloop")&&this.$.ea.sessionId&&(d.ULS.sendTraceTag(528348224,0,50,"AugmentationLoopManager.onNonRetryableCloseMessage: sending ObserverRequiredNotification, isSeedingRequired: false"),this.juc(!1))};this.Ec=(Oa,yb)=>{if(u.EwaSettings.isChangeGateEnabled("OfficeVSO:6443180_AvoidOnWorkbookClosingOnSilentReload")&&yb.fg)d.ULS.sendTraceTag(520677599,
0,50,"AugmentationLoopManager.onWorkbookClosing: event triggered due to silent reopen. Avoiding event with early return");else if(d.ULS.sendTraceTag(537170381,0,50,`AugmentationLoopManager.onWorkbookClosing: handler invoked
      (IsAppBeforeUnload == ${this.$.oLa}, IsAppUnloading == ${this.$.aD}.`),this.$.oLa||this.$.aD)this.Kxc(),u.EwaSettings.isChangeGateEnabled("OfficeVSO:6082895_ALAPIRefactorToSupportSignalWorkflowsWhenECSDown")&&this.Nue(4),this.pYc(),this.iT.closeSession().catch(Ob=>{d.ULS.sendTraceTag(526406240,0,50,`AugmentationLoopManager.onWorkbookClosing: closeSession promise rejected with error ${Ob}`)})};this.FFa=Oa=>{d.ULS.sendTraceTag(537170380,0,50,"Annotation Received");if(Oa)if(Oa.items){var yb;({value:yb}=
this.Jla.Dc(da.a.dKa(Oa),0));if(0===yb)d.ULS.sendTraceTag(537170377,0,10,"AugmentationLoopManager.annotationCallback: Operation Type not supported "+da.a.dKa(Oa));else{var Ob=!0;for(const lb of Oa.items){if(!lb){d.ULS.sendTraceTag(537170376,0,10,"AugmentationLoopManager.annotationCallback: Error in item");continue}if(!(da.a.byi(Oa,[D.getTypeName()])||lb.body&&this.Jdi(lb.body))){d.ULS.sendTraceTag(537170375,0,10,"AugmentationLoopManager.annotationCallback: Body is either null or not an annotation.");
continue}if(u.EwaSettings.isChangeGateEnabled("OfficeVSO:6530013_FilterOutAnnotationsAccordingToOwner")){var Ja=lb.source;if(this.lZb.includes(Ja)){d.ULS.sendTraceTag(520677597,0,50,`AugmentationLoopManager.annotationCallback: Filtered out annotation of owner ${Ja}`);continue}}Ja=da.a.dKa(lb.body);if(!Ja){d.ULS.sendTraceTag(523329624,0,50,"AugmentationLoopManager.annotationCallback: annotationType is null");continue}const Pb=lb.body;if(!Pb){d.ULS.sendTraceTag(523329623,0,50,"AugmentationLoopManager.annotationCallback: annotation is null");
continue}const Jb=new n(Pb,null,Oa.parentPath,yb);Ob=this.Zwj(Pb)&&Ob;d.ULS.sendTraceTag(576271178,0,50,`AugmentationLoopManager.annotationCallback: Triggering Event handler for Annotation ${Ja}. Should report: ${Ob}. ParentRevId: ${Oa.parentRevId}`);u.EwaSettings.isChangeGateEnabled("OfficeVSO:6082895_ALAPIRefactorToSupportSignalWorkflowsWhenECSDown")&&this.c_b.Yii(Jb.rJ.id,Oa.parentRevId)&&(this.raiseEvent(this.Dud(Ja),Jb,this),d.ULS.sendTraceTag(520677596,0,100,`AugmentationLoopManager.annotationCallback: raising newAnnotation event (annotation type: ${Ja})`));
this.c_b.gyd(Ja,Jb,Oa.parentRevId);this.raiseEvent(Ja,Jb,this)}this.fic&&Ob&&(Oa=r.a(this.Lh,this.fic.FYd),d.ULS.sendTraceTag(590906632,0,50,`AugmentationLoopManager.annotationCallback: Got valid annotation, time elapse from last state id(${this.fic.stateId}): ${Oa}`))}}else d.ULS.sendTraceTag(537170378,0,10,"AugmentationLoopManager.annotationCallback: Operation has no items");else d.ULS.sendTraceTag(537170379,0,10,"AugmentationLoopManager.annotationCallback: Operation is null")};this.gy=(Oa,yb)=>
{-1!==yb.frf&&(this.fic=Object(b.a)(new l,{stateId:yb.frf,FYd:this.Lh.Nb}))};this.Ela=()=>{const Oa=r.b(this.Lh,this.CAb),yb=this.$.ea.D3,Ob=this.$.ea.o0;this.Kpf<=Oa&&Ob<this.KSa&&!yb?(this.CAb=this.Lh.Nb,d.ULS.sendTraceTag(520677595,0,50,`AugmentationLoopManager.onUserActivityThrottled: Submitting keepalive custom message. secondsSinceLastKeepAlive: ${Oa}, timeInSecFromLastStatefulSuccessfulRequest: ${Ob}, deploymentOrTimedOutError: ${yb}`),this.iT.submitCustomMessage(Object(b.a)(new I,{message:new O})).catch(Ja=>
{d.ULS.sendTraceTag(526406239,0,50,`AugmentationLoopManager.onUserActivityThrottled: submitCustomMessage promise rejected with error ${Ja}`)})):this.Kpf<=Oa&&d.ULS.sendTraceTag(520632032,0,50,`AugmentationLoopManager.onUserActivityThrottled: Not submitting keepalive custom message. secondsSinceLastKeepAlive: ${Oa}, timeInSecFromLastStatefulSuccessfulRequest: ${Ob}, deploymentOrTimedOutError: ${yb}`)};this.Oxd=(Oa,yb)=>{Oa=yb.rJ;d.ULS.shipAssertTag(537170373,306,!!Oa,"AugmentationLoopManager.ObserverStatusAnnotationHandler: ObserverStatusAnnotation is null.");
u.EwaSettings.isChangeGateEnabled("OfficeVSO:6621501_LogObserverStatusAnnotationReceivedDuringSilentReload")&&d.ULS.sendTraceTag(520677594,0,50,`AugmentationLoopManager.observerStatusAnnotationHandler: received ${JSON.stringify(Oa)}`);this.isObserverRequired=Oa.isSeedingRequired&&Oa.isObserverRequired;this.$.ea.sessionId&&(d.ULS.sendTraceTag(520677593,0,50,`AugmentationLoopManager.observerStatusAnnotationHandler: sending ObserverRequiredNotification, isObserverRequired: ${this.isObserverRequired}`),
this.juc(this.isObserverRequired))};this.BBa=(Oa,yb)=>{var Ob;(null===(Ob=null===yb||void 0===yb?void 0:yb.dd)||void 0===Ob?0:Ob.WorkbookCoauthVersion)&&this.ATi(yb.dd.WorkbookCoauthVersion,yb.context)};this.Lh=Sa||w.a.Wa;this.CAb=this.Lh.Nb;this.$=na;this.iT=Na;this.c_b=Va;d.ULS.sendTraceTag(520679433,0,50,`AugmentationLoopManager.constructor: setAnnotationResultCallback : ${null===(vb=this.FFa)||void 0===vb?void 0:vb.name}`);this.iT.setAnnotationResultCallback(Object(b.a)(new A,{handler:this.FFa}));
this.J$h();this.$.ea.kE(this.gy);this.$.kk(this.Ec);this.fic=Object(b.a)(new l,{stateId:0,FYd:this.Lh.Nb});this.$.da.Ga(328,this);this.Kpf=this.$.ya.MinimumSecondsBetweenKeepAlivesFromBrowserToAugloop;this.KSa=60*this.$.ya.UserActiveTimeSinceLastActivityInMinutes;this.$.ea.jk(this.Xc);this.$.oa.Ir(this.BBa);u.EwaSettings.isChangeGateEnabled("OfficeVSO:6530013_FilterOutAnnotationsAccordingToOwner")&&this.u8h();this.azg();this.Syg()}u8h(){u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableLintBatchLoad",
!1)?this.lZb.push("TableLint-Grid-Column"):this.lZb.push("Tablelint-Column");u.EwaSettings.isChangeGateEnabled("OfficeVSO:7001231_IgnoreXlimVNextAnnotations")&&this.lZb.push("ExcelTableRecognitionReducer")}xHh(){return new Ga}register(na){this.slc.set(na.featureName,na.AJ);for(const Na of na.annotations)this.BXa(Object.assign(Object.assign({},Na),{featureName:na.featureName})),Na.LCb&&this.Ike(Na.annotationType,Na.LCb),Na.HYd&&this.O1.bP("Valid",Na.annotationType,Na.HYd),Na.$kd&&this.O1.bP("Invalid",
Na.annotationType,Na.$kd)}unregister(na){this.slc.delete(na);this.EXa.filter(Na=>Na.featureName===na).forEach(Na=>{Na.LCb&&this.c$i(Na.annotationType,Na.LCb);Na.HYd&&this.O1.IPa("Valid",Na.annotationType,Na.HYd);Na.$kd&&this.O1.IPa("Invalid",Na.annotationType,Na.$kd)})}EXb(na){this.tlc.push(na);d.ULS.sendTraceTag(520679432,0,50,`AugmentationLoopManager.addCloseCallback: ${null===na||void 0===na?void 0:na.name}`)}Yvh(na){var Na;return null!==(Na=this.Zvh.get(na))&&void 0!==Na?Na:0}Dud(na){return`New_${na}ALManager`}Ike(na,
Na){d.ULS.sendTraceTag(520679429,0,50,`AugmentationLoopManager.addNewAnnotationCallback: annotationType: ${na}, handler: ${null===Na||void 0===Na?void 0:Na.name}`);this.addHandler(this.Dud(na),Na)}c$i(na,Na){this.removeHandler(this.Dud(na),Na)}bP(na,Na){d.ULS.sendTraceTag(520679428,0,50,`AugmentationLoopManager.addAnnotationCallback: annotationType: ${na}, handler: ${null===Na||void 0===Na?void 0:Na.name}`);this.addHandler(na,Na)}IPa(na,Na){this.removeHandler(na,Na)}Zje(na){d.ULS.sendTraceTag(520679427,
0,50,"AugmentationLoopManager.addCoauthVersionChangedCallback");this.addHandler("CoauthVersionChangedALManager",na)}lOf(na){d.ULS.sendTraceTag(520679426,0,50,"AugmentationLoopManager.removeCoauthVersionChangedCallback called");this.removeHandler("CoauthVersionChangedALManager",na)}activateAnnotation(na,Na=null){d.ULS.sendTraceTag(537170390,0,50,`AugmentationLoopManager.activateAnnotation: activating annotation type: ${na}.`);this.pSc.has(na)&&d.ULS.sendTraceTag(537170389,0,50,`AugmentationLoopManager.activateAnnotation: Annotations ${na} were already activated in client session.`);
this.pSc.add(na);this.jf||(this.jf=this.$.ea.jf,this.jf.ora(this.Ela));this.iT.activateAnnotation(Object(b.a)(new y,{annotationType:na,stateUpdateHandler:Na})).then(Va=>{Va||d.ULS.sendTraceTag(537170388,0,10,"AugmentationLoopManager.activateAnnotation: ActivateAnnotationsResult is null");return null}).catch(Va=>{d.ULS.sendTraceTag(526406243,0,50,`AugmentationLoopManager.activateAnnotation: activateAnnotation promise rejected with error ${Va}`)})}BXa(na){d.ULS.sendTraceTag(520679425,0,50,`AugmentationLoopManager.activateAnnotation: activating annotation type: ${na.annotationType}.`);
this.EXa.includes(na)?d.ULS.sendTraceTag(520679424,0,50,`AugmentationLoopManager.activateAnnotation: Annotations ${na.annotationType} were already activated in client session.`):this.EXa.push(na);this.jf||(this.jf=this.$.ea.jf,this.jf.ora(this.Ela));u.EwaSettings.isChangeGateEnabled("OfficeVSO:6044361_XLALCatchPromiseFailures")?this.iT.activateAnnotation(Object(b.a)(new y,{annotationType:na.annotationType,stateUpdateHandler:na.$Ig})).then(Na=>{Na||d.ULS.sendTraceTag(520677603,0,10,"AugmentationLoopManager.activateAnnotation: ActivateAnnotationsResult is null");
return null}).catch(Na=>{d.ULS.sendTraceTag(520677602,0,50,`AugmentationLoopManager.activateAnnotation: activateAnnotation promise rejected with error ${Na}`)}):this.iT.activateAnnotation(Object(b.a)(new y,{annotationType:na.annotationType,stateUpdateHandler:na.$Ig})).then(Na=>{Na||d.ULS.sendTraceTag(520677601,0,10,"AugmentationLoopManager.ActivateAnnotation: ActivateAnnotationsResult is null");return null})}submitOperation(na){d.ULS.shipAssertTag(537170387,0,!!na,"AugmentationLoopManager.submitOperation: operation is null");
d.ULS.sendTraceTag(537170386,0,50,`AugmentationLoopManager.submitOperation: submitting operation of type '${da.a.dKa(na)}'`);this.iT.submitOperation(Object(b.a)(new F,{operation:na}))}pTd(na){d.ULS.shipAssertTag(537170385,0,!!na,"AugmentationLoopManager.submitOperationSignal: signal is null");const Na=Object.getTypeName(na);d.ULS.sendTraceTag(537170384,0,50,`AugmentationLoopManager.submitOperationSignal: submitting operation signal of type '${Na}'`);this.iT.submitOperation(Object(b.a)(new F,{operation:Object(b.a)(new K.a,
{parentPath:["Signal",Object.getTypeName(na)],items:[Object(b.a)(new M.a,{body:na})]})}))}registerLocalWorkflow(na){d.ULS.shipAssertTag(537170383,0,!!na,"AugmentationLoopManager.registerLocalWorkflow: workflow is null");d.ULS.sendTraceTag(537170382,0,50,`AugmentationLoopManager.registerLocalWorkflow: registering local workflow '${na.id}'`);this.iT.registerLocalWorkflow(Object(b.a)(new z,{workflow:na}))}WTj(na,Na,Va,Sa){na=Object(b.a)(new Z,{heightPx:Sa,widthPx:Va,contents:[Object(b.a)(new pa,{id:Na+
".0",format:2,size:3,sizeBytes:na.length,data:na})]});Na=Object(b.a)(new M.a,{id:Na,body:na});Na=Object(b.a)(new R,{item:Na});d.ULS.sendTraceTag(520677600,0,50,"AugmentationLoopManager.uploadImage: submitting custom message");this.iT.submitCustomMessage(Object(b.a)(new I,{message:Na})).catch(vb=>{d.ULS.sendTraceTag(526406241,0,50,`AugmentationLoopManager.uploadImage: submitCustomMessage promise rejected with error ${vb}`)})}get O1(){return this.c_b}dispose(){this.$&&this.$.ea&&this.$.ea.Ik(this.Xc);
this.$&&this.$.oa&&this.$.oa.qt(this.BBa);this.tlc=[];this.slc.clear();this.Kxc();super.dispose()}Kxc(){this.jf&&(this.jf.SPa(this.Ela),this.jf=null);this.$.ea.BD(this.gy)}pYc(){for(let na of this.tlc)try{na()}catch(Na){d.ULS.sendTraceTag(528016151,0,10,`AugmentationLoopManager.callAndClearAugloopCloseCallbacks: exception thrown at callback invocation with message: ${Na.message}`)}this.tlc=[]}Nue(na){for(const Na of this.slc.values())try{Na(na,void 0)}catch(Va){d.ULS.sendTraceTag(520677598,0,10,String.format(`AugmentationLoopManager.callAndClearAugloopCloseCallbacks: exception thrown at callback invocation with message: ${Va.message}`))}}J$h(){this.Jla=
new Ra.a;this.Jla.ia(X.a.getTypeName(),1);this.Jla.ia(V.a.getTypeName(),2);this.Jla.ia(T.getTypeName(),5);this.Jla.ia(D.getTypeName(),3);this.Jla.ia(W.getTypeName(),7);this.Jla.ia(J.getTypeName(),6);this.Jla.ia(L.getTypeName(),4)}Jdi(na){return da.a.dKa(na)===U.a.getTypeName()||0<=Array.indexOf(da.a.EVe(na),U.a.getTypeName())}Zwj(na){if(na){if(u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.SharedOnline.AutoCLPV2Transition",!1)){var Na=!!na.recommended&&!!na.recommended.id;return!!na.automatic&&
!!na.automatic.id||Na}Na=!!na.recommended&&!!na.recommended.sensitivityLabel&&!!na.recommended.sensitivityLabel.id;return!!na.automatic&&!!na.automatic.sensitivityLabel&&!!na.automatic.sensitivityLabel.id||Na}return!1}Syg(){u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UnitTelemetryAL",!1)&&(u.EwaSettings.isChangeGateEnabled("OfficeVSO:6082895_ALAPIRefactorToSupportSignalWorkflowsWhenECSDown")?this.BXa({annotationType:"AugLoop_UnitTelemetry_UnitTelemetryAggregatedAnnotation",Vyb:!0}):
this.activateAnnotation("AugLoop_UnitTelemetry_UnitTelemetryAggregatedAnnotation"));u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TablelintComparison",!1)&&this.BXa({annotationType:"AugLoop_Excel_ExcelComparisonAnnotation",Vyb:!0})}azg(){u.EwaSettings.isChangeGateEnabled("OfficeVSO:6082895_ALAPIRefactorToSupportSignalWorkflowsWhenECSDown")?(this.BXa({annotationType:ea.getTypeName(),Vyb:!0,LCb:this.Oxd}),this.Ike(ea.getTypeName(),this.Oxd)):(this.activateAnnotation(ea.getTypeName()),
this.bP(ea.getTypeName(),this.Oxd))}juc(na){v(this.$.oa.va,na,null,null,null,null)}ATi(na,Na){if(this.iCc.DocId!==na.DocId||this.iCc.Xluid!==na.Xluid&&this.iCc.Xrevid!==na.Xrevid)this.iCc=na,u.EwaSettings.isChangeGateEnabled("OfficeVSO:6082895_ALAPIRefactorToSupportSignalWorkflowsWhenECSDown")&&this.raiseEvent("CoauthVersionChangedALManager",{coauthVersion:na,userContext:Na},this),this.c_b.zTi(na,Na.userContext)}}Object(t.a)(Ba,"AugmentationLoopManager",k.a,[813,2]);var fa=a(4),Y=a(380),ja=a(193),
ca=a(146),aa=a(30),ta=a(84),xa=a(54);class ia{constructor(){this.powerpoint=this.downloadPolymerBaseUrl=this.inferenceServiceVersion=this.downloadBaseUrl=this.sessionCreationOptions=this.disabledServiceGroups=this.privateMode=this.flights=this.excelServer=this.initSession=this.sessionId=this.releaseFork=this.releaseChannel=this.releaseAudienceGroup=this.uiLanguage=this.appVersion=this.appName=this.serviceUrl=null}}Object(t.a)(ia,"InitializeParameters",null,[]);class ya{constructor(){this.networkMode=
this.egress=this.localRegisteredWorkflows=this.enableComplexLocalWorkflows=this.serviceUrl=this.onSessionClose=this.onSessionReconnect=this.onSessionDisconnect=this.onSessionConnect=this.flights=this.extensionConfigs=this.docSessionId=null}}Object(t.a)(ya,"SessionCreationOptions",null,[]);class ib{constructor(){this.featureEnabledCallback=null}}Object(t.a)(ib,"SetIsFeatureEnabledCallbackParameters",null,[]);class wa{constructor(){this.requestAuthTokenCallback=null}}Object(t.a)(wa,"SetRequestAuthTokenCallbackParameters",
null,[]);class sa{constructor(){this.sendOTelEvent=null}}Object(t.a)(sa,"SetSendOTelEventCallbackParameters",null,[]);class Ya{constructor(){this.handler=null}}Object(t.a)(Ya,"SetSessionInitOverrideCallbackParameters",null,[]);class bb{constructor(){this.ulsLogger=null}}Object(t.a)(bb,"SetULSLoggerParameters",null,[]);class mb extends da.a{constructor(){super();this.supportCustomMessages=this.accessTokenTTL=this.accessToken=this.collabStateId=this.collabUserListVersion=this.configurations=this.permissionFlags=
this.serverEventVersion=this.workbookMetadataVersion=this.ecsOperationUrl=this.restUrl=this.ecsId=this.cluster=null;this.H_=Object.assign(new H.a,{T_:mb.getTypeName(),B_:mb.Pd()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelServerSessionExtensionConfig"}static Pd(){return[]}}Object(t.a)(mb,"ExcelServerSessionExtensionConfig",da.a,[]);var Ca=a(861),$a=a(196);class Kb{static Iri(na,Na,Va){if(Kb.b_b)return d.ULS.sendTraceTag(537170369,0,15,"augloop: LoadAndInitializeAugLoopRuntimeManager called more than once"),
Kb.b_b;const Sa=fa.AFrameworkApplication.fa.Va("AugLoopCloudALServiceUrl");if(!Sa||!Sa.length)return d.ULS.sendTraceTag(537170368,0,15,"AugmentationLoopRuntimeProxy.LoadAndInitializeAugLoopRuntimeManager: AugLoopCloudALServiceUrl is null or empty"),Promise.reject(null);Va=$a.a(xa.a.loadScript(83,4,Va,void 0,void 0,327));Kb.b_b=Va.then(()=>{const vb=augLoop.ALFactoryGlobal.getAugLoopRuntimeManager();Kb.y9h(na,Na,vb);return Promise.resolve(vb)}).catch(vb=>{d.ULS.sendTraceTag(537170339,0,10,"augloop: Failed to download script:"+
vb);return Promise.reject(null)});return Kb.b_b}static y9h(na,Na,Va){var Sa;d.ULS.sendTraceTag(537170338,0,50,"augloop: Successfully loaded script");Kb.Lh||Kb.yoj(w.a.Wa);Kb.Pmd=new Set;d.ULS.sendTraceTag(522803219,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: setIsFeatureEnabledCallback");Va.setIsFeatureEnabledCallback(Object(b.a)(new ib,{featureEnabledCallback:vb=>{const Oa=fa.AFrameworkApplication.fa.qa("AugLoop"+vb),yb=u.EwaSettings.getBooleanFeatureGate(vb,!1),Ob=u.EwaSettings.getBooleanFeatureGate("AugLoop"+
vb,!1),Ja=yb||Ob,lb=Oa||Ja;Kb.Pmd.has(vb)||(Kb.Pmd.add(vb),d.ULS.shipAssertTag(537170337,0,!(Oa&&!Ja),`AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager.isFeatureEnabled: legacy app setting return true for feature ${vb}, but feature gate return false. This is problem because app setting is depricated and about to be removed`),lb&&d.ULS.sendTraceTag(537170336,0,50,`AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager.isFeatureEnabled: feature ${vb} is enabled. legacyAppSettingResult: ${Oa}, featureGateWithoutPrefix: ${yb}, featureGateWithPrefix: ${Ob}`));
return lb}}));if(u.EwaSettings.ma(432))if(Na){let vb=Kb.M9b(Na);vb=Kb.M9b(Na,fa.AFrameworkApplication.fa.Va("AugloopACLPUserDataSignature"));d.ULS.sendTraceTag(522803218,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: Callback is passed to the augloop runtime which calls the code  when an auth token is required");Va.setRequestAuthTokenCallback(Object(b.a)(new wa,{requestAuthTokenCallback:vb}))}else d.ULS.sendTraceTag(537170335,0,10,"Oauth manager is null");d.ULS.sendTraceTag(522803217,
0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setULSLogger");Va.setULSLogger(Object(b.a)(new bb,{ulsLogger:new Y.a}));d.ULS.sendTraceTag(522803216,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setSendOTelEventCallback");Va.setSendOTelEventCallback(Object(b.a)(new sa,{sendOTelEvent:Kb.sendOTelEvent}));Na="";u.EwaSettings.ma(434)&&(Na+="AugmentationLoopObserverSession;");u.EwaSettings.ma(484)&&(Na+="AugmentationLoopIncrementalUpdates;");
u.EwaSettings.ma(440)&&(Na+="EnterpriseDataTypeMipSupport;");if(u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.ExcelOnline.TableLintExperiment",!1)||u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.ExcelOnline.TableLintProdExperiment",!1)||u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligence",!1)||u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UnitTelemetryAL",!1))Na+="LoadAdditionalDataToModel;";u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.DataCleansingTaskPane",
!1)&&(Na+="DataCleansingSlice0;LoadAdditionalDataToModel;");u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugloopNoLatency",!1)&&(Na+="AugloopNoLatency;");u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableLintInvestigationTelemetry",!1)&&(Na+="TableLintInvestigationTelemetry;");u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TelemetryWorkflowIncludeTextHints",!1)&&(Na+="TelemetryWorkflowIncludeTextHints;");u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.Insights.UseTableRecoMLTableIntelligence",
!1)&&(Na+="UseTableRecoMLTableIntelligence;");u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligenceLogging",!1)&&(Na+="TableIntelligenceLogging;");u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugloopWaitForWorkbookChangeState",!1)&&(Na+="AugloopWaitForWorkbookChangeState;");u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.XLALReadMetadataFromUserEcsSession",!1)&&(Na+="XLALReadMetadataFromUserEcsSession;");u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligenceSheetCountThreshold",
!1)&&(null===(Sa=null===na||void 0===na?void 0:na.xa)||void 0===Sa?0:Sa.count)&&na.xa.count>u.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.TableIntelligenceSheetCountThresholdValue",100)&&(Na+="TableIntelligenceSheetCountThreshold;",d.ULS.sendTraceTag(521151777,306,50,`TableIntelligence max sheet count exceeded. SheetCount: ${na.xa.count}`));Sa=u.EwaSettings.ULh();for(const vb of Sa)Na+=`${vb}=false;`;d.ULS.sendTraceTag(522803215,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setInitSessionCallback");
Va.setInitSessionCallback({initSessionCallback:()=>{var vb;if(null===(vb=null===na||void 0===na?void 0:na.ea)||void 0===vb?0:vb.sessionId)return d.ULS.sendTraceTag(527708568,0,50,`AugmentationLoopRuntimeProxy.setInitSessionCallback: initSessionCallback called, sessionId is valid (length = ${na.ea.sessionId.length}), return resolved promise`),Promise.resolve();d.ULS.sendTraceTag(527708567,0,50,"AugmentationLoopRuntimeProxy.setInitSessionCallback: initSessionCallback called, sessionId is not valid, return promise that will be resolved when session id will be valid again.");
return new Promise(Oa=>{var yb;const Ob=()=>{var Ja;(null===(Ja=null===na||void 0===na?void 0:na.ea)||void 0===Ja?0:Ja.sessionId)?(d.ULS.sendTraceTag(527708566,0,50,`AugmentationLoopRuntimeProxy.setInitSessionCallback: sessionId changed callback called with valid session id (length = ${na.ea.sessionId.length}), resolve the promise and unregister the callback.`),na.ea.Ik(Ob),Oa()):d.ULS.sendTraceTag(527708565,0,50,"AugmentationLoopRuntimeProxy.setInitSessionCallback: sessionId changed callback called, but the session id is not valid yet, keep waiting.")};
null===(yb=null===na||void 0===na?void 0:na.ea)||void 0===yb?void 0:yb.jk(Ob)})}});d.ULS.sendTraceTag(522803214,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setSessionInitOverrideCallback");Va.setSessionInitOverrideCallback(Object(b.a)(new Ya,{handler:vb=>{vb.extensionConfigs=[Object(b.a)(new mb,{cluster:na.ya.MachineCluster,ecsId:Kb.sMh(na),restUrl:na.ya.RestActionUrl,ecsOperationUrl:"",workbookMetadataVersion:0,serverEventVersion:0,permissionFlags:0,configurations:0,
collabUserListVersion:0,collabStateId:0,accessToken:na.ya.AccessToken,accessTokenTTL:na.ya.AccessTokenValidTo.toString()})];d.ULS.sendTraceTag(537170334,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: access token TTL "+na.ya.AccessTokenValidTo.toString());return vb}}));d.ULS.sendTraceTag(522803213,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.initialize - onSessionClose: getOnCloseMessageCallback ");Va.initialize(Object(b.a)(new ia,{serviceUrl:fa.AFrameworkApplication.fa.Va("AugLoopCloudALServiceUrl"),
appName:"Excel",appVersion:fa.AFrameworkApplication.fa.Va("BuildVersion")||"",releaseAudienceGroup:fa.AFrameworkApplication.Qb?Object(ta.a)(String,fa.AFrameworkApplication.Qb.AudienceGroup)||"":"",releaseChannel:null,releaseFork:null,sessionId:na.ya.UserSessionId,initSession:!0,flights:Na,uiLanguage:fa.AFrameworkApplication.uiCulture,excelServer:null,sessionCreationOptions:u.EwaSettings.isChangeGateEnabled("OfficeVSO:6082895_ALAPIRefactorToSupportSignalWorkflowsWhenECSDown")?Object(b.a)(new ya,{onSessionClose:Kb.s_e()}):
Object(b.a)(new ya,{onSessionClose:Kb.s_e(Va)})}))}static s_e(na){return Na=>{var Va,Sa;let vb=!ja.a.instance.DQ(fa.AFrameworkApplication.ik);if(vb)if(Na)if(Na.reason){const Oa=Na.reason;d.ULS.shipAssertTag(537170333,0,!(void 0===Oa.isRetryableError||null===Oa.isRetryableError),"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: closeReason.IsRetryableError is null");vb=(null==Oa.isRetryableError?!0:Oa.isRetryableError)&&vb}else d.ULS.sendTraceTag(537170332,0,15,"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: closeMessage.Reason is null");
else d.ULS.shipAssertTag(537170331,0,!1,"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: - closeMessage is null");else d.ULS.sendTraceTag(537170330,0,15,"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: access token has expired");d.ULS.sendTraceTag(537170329,0,15,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: On close message callback is called. shouldRetry is set to ${vb}`);vb&&((!Kb.KMb||r.a(Kb.Lh,Kb.KMb)>Kb.hMf)&&Kb.Bfj(),Kb.oqc<Kb.Wud?(Kb.oqc++,d.ULS.sendTraceTag(537170328,
0,50,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: Start new session attempt ${Kb.oqc} of ${Kb.Wud}. Time of first attempt in this interval of reconnects: ${Kb.KMb}`)):(d.ULS.sendTraceTag(537170327,0,15,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: Reached the limit of ${Kb.Wud} attempts for session creation under interval of ${Kb.hMf} Ms. Stop trying to reconnect. Time of first attempt in this iterval: ${Kb.KMb}.`),vb=!1));u.EwaSettings.isChangeGateEnabled("OfficeVSO:6082895_ALAPIRefactorToSupportSignalWorkflowsWhenECSDown")?
Kb.Duf(vb,null===(Va=null===Na||void 0===Na?void 0:Na.reason)||void 0===Va?void 0:Va.errorType,null===(Sa=null===Na||void 0===Na?void 0:Na.reason)||void 0===Sa?void 0:Sa.errorCode):vb?(na.startNewSession(),Kb.ZAf()):Kb.xzf()}}static $qj(na){Kb.xzf=na}static Qrj(na){Kb.ZAf=na}static Aoj(na){Kb.Duf=na}static yoj(na){Kb.Lh=na}static Bfj(){Kb.oqc=0;Kb.KMb=Kb.Lh.Nb}static M9b(na,Na=""){return()=>{try{return d.ULS.sendTraceTag(527970953,0,50,`AugmentationLoopRuntimeProxy.getAuthTokenDelegate: called with fallbackValue.length: ${Na.length}.`),
na.wO("AugLoop",fa.AFrameworkApplication.fa.Va("AugLoopOAuthResourceUriV2")).then(Va=>{if(Va.IsSuccess)return d.ULS.sendTraceTag(527970952,0,50,"AugmentationLoopRuntimeProxy.getAuthTokenDelegate: successfully fetch token."),Va.Token;d.ULS.sendTraceTag(537170326,0,15,`AugmentationLoopRuntimeProxy.getAuthTokenDelegate: failed to get token, use fallback value (length: ${Na.length})`);return Na},()=>{d.ULS.sendTraceTag(537170325,0,15,"AugmentationLoopRuntimeProxy.getAuthTokenDelegate: got rejected promise, use fallback value");
return Na})}catch(Va){return d.ULS.sendTraceTag(537170324,0,10,"Exception thrown when fetching token"),Promise.resolve(Na)}}}static sendOTelEvent(na){ca.a.sendOtelEvent(Object(b.a)(new Ca.a,{otelEvent:na}))}static sMh(na){const Na=aa.a.ff(na.ea.sessionId);na=u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.XLALReadMetadataFromUserEcsSession",!1)?`cluster=${na.ya.MachineCluster}&session=${Na}&usid=${na.ya.UserSessionId}`:"";u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.XLALReadMetadataFromUserEcsSession",
!1)&&u.EwaSettings.isChangeGateEnabled("OfficeVSO:5897059_XLALInvestigateIncorrectSessionId")&&d.ULS.sendTraceTag(528348230,0,50,`AugmentationLoopRuntimeProxy.getEcsSessionId: ecsSessionId length is ${na.length}`);return na}}Kb.Wud=3;Kb.hMf=3E5;Kb.oqc=0;Kb.KMb=null;Kb.Lh=null;Kb.b_b=null;Kb.Duf=null;Kb.ZAf=null;Kb.xzf=null;Kb.Pmd=null;Object(t.a)(Kb,"AugmentationLoopRuntimeProxy",null,[]);var rb=a(50),cc=a(37),nc=a(186),Wb;(function(na){na.newAnnotation="New";na.validAnnotation="Valid";na.invalidAnnotation=
"Invalid"})(Wb||(Wb={}));Object(t.b)("AnnotationCallbackType",Wb);var Ea;(function(na){na.newAnnotation="New";na.validOnArrivalAnnotation="ValidOnArrival";na.validAfterSomeTimeAnnotation="ValidAfterSomeTime";na.invalidOnCoauthVersionChangedAnnotation="InvalidOnCoauthVersionChanged";na.invalidAfterTimeoutAnnotation="InvalidAfterTimeout"})(Ea||(Ea={}));Object(t.b)("AnnotationEventType",Ea);var ua;(function(na){na[na.beforeAnnotation=0]="beforeAnnotation";na[na.atAnnotation=1]="atAnnotation";na[na.afterAnnotation=
2]="afterAnnotation"})(ua||(ua={}));Object(t.b)("TimelinePosition",ua);class ma{constructor(){this.Vdb=new Map;d.ULS.sendTraceTag(520176320,0,50,"AugmentationLoopAnnotationValidatorLogger.constructor: called")}Qje(na){this.Vdb.has(na)||(d.ULS.sendTraceTag(520176291,0,50,`AugmentationLoopAnnotationValidatorLogger.addAnnotationType: ${na}`),this.Vdb.set(na,[]))}n9i(na){this.Vdb.delete(na)&&d.ULS.sendTraceTag(520176290,0,50,`AugmentationLoopAnnotationValidatorLogger.removeAnnotationType: ${na}`)}YNi(na,
Na){na.find(Va=>Va.annotationId===Na)||na.push({annotationId:Na,AJj:Date.now(),jZb:Ea.newAnnotation})}pui(na,Na,Va,Sa){d.ULS.sendTraceTag(520176289,0,50,`AugmentationLoopAnnotationValidatorLogger.logLatencyEntry: type: ${na}, entry: (${Na.annotationId} ${Na.jZb}) incoming: ${Sa}, latency: ${Va-Na.AJj} ms`)}y4h(na,Na,Va){return(Va===Ea.validAfterSomeTimeAnnotation||Va===Ea.validOnArrivalAnnotation)&&(na.annotationId===Na||na.jZb===Ea.invalidAfterTimeoutAnnotation)}JSi(na,Na,Va,Sa){let vb=[];const Oa=
Date.now();let yb=ua.beforeAnnotation;for(let Ob of Na){this.y4h(Ob,Va,Sa)&&this.pui(na,Ob,Oa,Sa);if(Ob.annotationId===Va){Ob.jZb=Sa;if(Sa===Ea.invalidAfterTimeoutAnnotation)return;yb=ua.atAnnotation}else yb===ua.atAnnotation&&(yb=ua.afterAnnotation);Na=Sa===Ea.invalidOnCoauthVersionChangedAnnotation?Ob.annotationId!==Va:Ob.jZb===Ea.newAnnotation;const Ja=yb===ua.afterAnnotation;(yb!==ua.afterAnnotation&&Na||Ja)&&vb.push(Ob)}this.Vdb.set(na,vb)}kFi(na,Na,Va){let Sa=this.Vdb.get(na);Sa||(this.Qje(na),
Sa=this.Vdb.get(na));Va===Ea.newAnnotation?this.YNi(Sa,Na):this.JSi(na,Sa,Na,Va)}}Object(t.a)(ma,"AugmentationLoopAnnotationValidatorLogger",null,[]);class fb{constructor(na,Na){this.toString=()=>JSON.stringify(this);this.annotationId=na;this.coauthVersion=Na}}Object(t.a)(fb,"LocalAnnotationId",null,[]);class sb extends k.a{constructor(na=36E5){super();this.zMa=new Map;this.CZ=new Map;this.fOa=new Set;this.QYd=new ma;this.nni=u.EwaSettings.isChangeGateEnabled("OfficeVSO:6082895_ALAPIRefactorToSupportSignalWorkflowsWhenECSDown");
this.sQe=na;d.ULS.sendTraceTag(523337872,0,50,`AugmentationLoopAnnotationValidator.constructor: annotationExpirationTimeout: ${this.sQe} ms`)}dispose(){d.ULS.sendTraceTag(523337871,0,50,`AugmentationLoopAnnotationValidator.dispose: ${this.getStatus()}`);this.fOa.clear();this.CZ.clear();this.zMa.clear();super.dispose()}Zje(na){d.ULS.sendTraceTag(521405910,0,50,"AugmentationLoopAnnotationValidator.addCoauthVersionChangedCallback");this.addHandler("CoauthVersionChanged",na)}lOf(na){d.ULS.sendTraceTag(521405909,
0,50,"AugmentationLoopAnnotationValidator.removeCoauthVersionChangedCallback");this.removeHandler("CoauthVersionChanged",na)}bP(na,Na,Va){d.ULS.sendTraceTag(521405908,0,50,`AugmentationLoopAnnotationValidator.addAnnotationCallback: annotationType: ${Na}`);this.addHandler(this.Bud(na,Na),Va);u.EwaSettings.isChangeGateEnabled("OfficeVSO:6807759_AugmentationLoopAnnotationValidatorLoggerEnabled")&&this.QYd.Qje(Na)}IPa(na,Na,Va){d.ULS.sendTraceTag(521405907,0,50,`AugmentationLoopAnnotationValidator.removeAnnotationCallback: annotationType: ${Na}`);
this.removeHandler(this.Bud(na,Na),Va);u.EwaSettings.isChangeGateEnabled("OfficeVSO:6807759_AugmentationLoopAnnotationValidatorLoggerEnabled")&&this.QYd.n9i(Na)}zTi(na,Na){d.ULS.sendTraceTag(523337870,0,50,this.nni?`AugmentationLoopAnnotationValidator.onWorkbookCoauthVersionUpdate: starting, raising CoauthVersionChanged event: ${c(na)}`:`AugmentationLoopAnnotationValidator.onWorkbookCoauthVersionUpdate: starting (${c(na)})`);this.raiseEvent("CoauthVersionChanged",{coauthVersion:na,userContext:Na},
this);this.qci(this.m4b);this.m4b=na;this.aVj(this.m4b);this.N$e();d.ULS.sendTraceTag(523337869,0,50,`AugmentationLoopAnnotationValidator.onWorkbookCoauthVersionUpdate: done ${this.getStatus()}`)}EQe(na){if(na)try{const vb=JSON.parse(na);var Na=vb.coauthVersionDocId,Va=vb.coauthVersionXluid,Sa=vb.coauthVersionXrevId;return{DocId:"undefined"===Na?void 0:Na,Xluid:"undefined"===Va?void 0:Va,Xrevid:"undefined"===Sa?void 0:parseInt(Sa,10)}}catch(vb){d.ULS.sendTraceTag(523337868,0,10,`AugmentationLoopAnnotationValidator.extractWorkbookCoauthVersion(${na}): Exception - ${vb}`)}}gyd(na,
Na,Va){Va=this.EQe(Va);void 0!==Va&&(d.ULS.sendTraceTag(523337867,0,50,`AugmentationLoopAnnotationValidator.onAnnotationReceived: starting ${na}: ${Na.operationType}: (annotation id ${Na.rJ.id}) at ${c(Va)}`),this.nBg({annotationType:na,Koe:Na},Va),this.N$e(),d.ULS.sendTraceTag(523337866,0,50,`AugmentationLoopAnnotationValidator.onAnnotationReceived: done ${this.getStatus()}`))}Bud(na,Na){return`${na}_${Na}`}getStatus(){var na,Na;const Va=c(this.m4b),Sa=null===(na=this.zMa)||void 0===na?void 0:na.size;
na=null===(Na=this.fOa)||void 0===Na?void 0:Na.size;return`current coauth version: ${Va}, ${Sa} known annotations, ${na} coauth versions on hold`}vGb(na,Na,Va,Sa){const vb=this.zMa.get(`${Na}`);na=this.Bud(na,vb.annotationType);d.ULS.sendTraceTag(523337865,0,50,`AugmentationLoopAnnotationValidator.raiseAnnotationEvent: ${Va} raising ${na} event (annotation id: ${Na})`);this.raiseEvent(na,vb.Koe,this);u.EwaSettings.isChangeGateEnabled("OfficeVSO:6807759_AugmentationLoopAnnotationValidatorLoggerEnabled")&&
this.QYd.kFi(vb.annotationType,`${Na}`,Sa)}Yii(na,Na){Na=c(this.EQe(Na));na=`${new fb(na,Na)}`;return!this.zMa.has(na)}nBg(na,Na){var Va=na.Koe.rJ.id;const Sa=c(Na);Va=new fb(Va,Sa);const vb=`${Va}`;this.zMa.has(vb)?d.ULS.sendTraceTag(523337864,0,50,`AugmentationLoopAnnotationValidator.addNewAnnotation: ignoring duplicate annotation (annotation id ${Va})`):(this.zMa.set(vb,na),this.CZ.has(Sa)?this.CZ.get(Sa).GFa.add(Va.annotationId):this.CZ.set(Sa,{GFa:new Set([Va.annotationId]),timestamp:Date.now()}),
this.vGb("New",Va,"addNewAnnotation","New"),na=this.m4b,Na===na||Na&&na&&Na.DocId===na.DocId&&Na.Xluid===na.Xluid&&Na.Xrevid===na.Xrevid?this.vGb("Valid",Va,"addNewAnnotation","ValidOnArrival"):this.fOa.add(c(Na)))}AOf(na){this.zMa.delete(`${na}`);for(let [Na,Va]of this.CZ.entries())if(Na===na.coauthVersion&&Va.GFa.delete(na.annotationId))break}x$i(){Array.from(this.CZ.entries()).filter(([,na])=>0===na.GFa.size).forEach(([na])=>this.CZ.delete(na))}GOf(na){this.fOa.delete(na)}qci(na){var Na;const Va=
c(na);(new Set(null===(Na=this.CZ.get(Va))||void 0===Na?void 0:Na.GFa)).forEach(Sa=>{Sa=new fb(Sa,Va);this.vGb("Invalid",Sa,"invalidateAnnotations","InvalidOnCoauthVersionChanged");this.AOf(Sa)})}aVj(na){var Na;na=c(na);if(this.fOa.has(na)){var Va=null===(Na=this.CZ.get(na))||void 0===Na?void 0:Na.GFa;Na=(Na=this.CZ.get(na))?Date.now()-Na.timestamp:0;for(const Sa of Va)Va=new fb(Sa,na),this.vGb("Valid",Va,`validateAnnotations elapsed ${Na} ms`,"ValidAfterSomeTime");this.GOf(na)}else d.ULS.sendTraceTag(523337863,
0,50,`AugmentationLoopAnnotationValidator.validateAnnotations: ${na} has no on-hold annotations associated with it`)}N$e(){var na=Date.now();const Na=[],Va=[];for(const vb of this.fOa){var Sa=this.CZ.get(vb);const Oa=na-Sa.timestamp;if(Oa>this.sQe)for(const yb of Sa.GFa)Sa=new fb(yb,vb),this.vGb("Invalid",Sa,`invalidateExpiredAnnotations elapsed ${Oa} ms`,"InvalidAfterTimeout"),Na.push(Sa)}for(const vb of Na)this.AOf(vb);for(const vb of this.fOa)na=this.CZ.get(vb),0===(null===na||void 0===na?void 0:
na.GFa.size)&&Va.push(vb);for(const vb of Va)this.GOf(vb);this.x$i()}}Object(t.a)(sb,"AugmentationLoopAnnotationValidator",k.a,[812]);class Ua extends C.a{constructor(na){super();this.augmentationLoopManager=null;this.$=na;this.Fb();d.ULS.sendTraceTag(520939607,0,50,"AugmentationLoopManagerFactory.constructor: called")}create(){const na=Date.now();f.Health.instance.recordKpiUsageForAlertableKpi("AugmentationLoopManagerCreation","xlalint",null);d.ULS.sendTraceTag(537170371,0,50,"AugmentationLoopManagerFactory.create: called");
let Na=null;const Va=[];u.EwaSettings.ma(432)&&(Na=rb.GetServiceTaskFactory.Ra(this.$.da,349,350,this.hb),Va.push(Na));cc.TaskExtensions.Aa(cc.TaskExtensions.Wd(Va,this.la,3),()=>{Kb.Iri(this.$,Na?Na.result:null,this.hb).then(Sa=>{d.ULS.sendTraceTag(537170370,0,50,"AugmentationLoopManagerFactory.create: Augmentation Loop runtime initialized");try{this.qb(this.augmentationLoopManager||(this.augmentationLoopManager=new Ba(this.$,Sa,new sb(this.$.ya.AugmentationLoopAnnotationExpirationTimeoutInMs)))),
u.EwaSettings.isChangeGateEnabled("OfficeVSO:6082895_ALAPIRefactorToSupportSignalWorkflowsWhenECSDown")?Kb.Aoj(this.augmentationLoopManager.Hlc):(Kb.Qrj(this.augmentationLoopManager.OPi),Kb.$qj(this.augmentationLoopManager.$Ni))}catch(vb){f.Health.instance.recordKpiFailure("AugmentationLoopManagerCreation","Exception",!1,!0,Object(b.a)(new nc.a,{extendedProperties:new Map,durationMs:Date.now()-na})),this.qb(null),d.ULS.sendTraceTag(42796228,0,10,`AugmentationLoopManagerFactory.create: Augmentation loop initialization failed. Exception ${vb.message}`)}}).catch(()=>
{f.Health.instance.recordKpiFailure("AugmentationLoopManagerCreation","PromiseRejected",!1,!0,Object(b.a)(new nc.a,{extendedProperties:new Map,durationMs:Date.now()-na}));this.qb(null);d.ULS.sendTraceTag(42796229,0,10,"AugmentationLoopManagerFactory.create: Augmentation loop initialization failed")})},this.$.la,3)}static ka(na){d.ULS.sendTraceTag(520939606,0,50,"AugmentationLoopManagerFactory.attach: called");na.da.Ga(327,new Ua(na))}}Object(t.a)(Ua,"AugmentationLoopManagerFactory",C.a,[]);var ab=
a(10);a=a(1214);Type.registerNamespace("_Ewa");(()=>{ab.a.Fa(na=>{Ua.ka(na)})})();Object(a.a)()},814:function(t,C,a){a.d(C,"g",function(){return e});a.d(C,"f",function(){return k});a.d(C,"c",function(){return l});a.d(C,"e",function(){return m});a.d(C,"d",function(){return v});a.d(C,"b",function(){return w});a.d(C,"a",function(){return y});t=a(0);var c=a(11),b=a(316),d=a(15),f=a(33);const e=(x,B,z,A)=>{d.ULS.sendTraceTag(221794372,306,50,`FormulaByExample suggestion display failure reported. Failure data ${JSON.stringify({["flowId"]:x.ui,
["originFormulaFlowId"]:x.dca.ui,["formulaAnonymized"]:x.anonymizedFormula,["originalFormulaAnonymized"]:x.dca.anonymizedFormula,["range"]:x.range,["failureReason"]:B})}`);z&&z.kt(x.ui,A,{reason:B})},k=(x,B,z)=>{try{const A=r(x,B,z);window.performance.mark(A)}catch(A){d.ULS.sendTraceTag(529109767,0,10,`FormulaByExampleTelemetryGenerator.markPerformancePoint: Error thrown : ${A.message}`)}},l=x=>{for(const B in n)try{window.performance.clearMarks(r(B,x,!1)),window.performance.clearMarks(r(B,x,!0))}catch(z){d.ULS.sendTraceTag(527005662,
0,10,`FormulaByExampleTelemetryGenerator.clearPerformanceFlowMarks: Error thrown : ${z.message}`)}},m=(x,B)=>{try{return{["EditCommitToSignal"]:u(`FBE_EditCommitToSignal_${B}_${x}`,r(n.EditCommit,B,!1),r(n.SignalSent,B,!1)),["WorkflowAndNetworkTime"]:x?0:u(`FBE_WorkflowAndNetworkTime_${B}_${x}`,r(n.SignalSent,B,!1),r(n.AnnotationReceived,B,!1)),["Calculation"]:u(`FBE_Calculation_${B}_${x}`,r(n.CalculationStart,B,x),r(n.CalculationEnd,B,x)),["ModelUpdate"]:u(`FBE_ModelUpdate_${B}_${x}`,r(n.CalculationEnd,
B,x),r(n.ModelUpdated,B,x)),["PreviewRender"]:u(`FBE_PreviewRendered_${B}_${x}`,r(n.ModelUpdated,B,x),r(n.PreviewRendered,B,x)),["Total"]:u(`FBE_Total_${B}_${x}`,r(n.EditCommit,B,!1),r(n.PreviewRendered,B,x))}}catch(z){d.ULS.sendTraceTag(529109766,0,10,`FormulaByExampleTelemetryGenerator.getPreviewShownDurations: Error thrown : ${z.message}`)}},v=(x,B)=>{try{return{["UserInPreviewDuration"]:u(`FBE_InputToPreviewRemovedWithCSE_${B}_${x}`,r(n.PreviewRendered,B,x),r(n.UserInputArrived,B,x)),["InputToPreviewRemovedWithCSE"]:u(`FBE_InputToPreviewRemovedWithCSE_${B}_${x}`,
r(n.UserInputArrived,B,x),r(n.PreviewRemovedWithCSE,B,x))}}catch(z){d.ULS.sendTraceTag(529109765,0,10,`FormulaByExampleTelemetryGenerator.getPreviewRemovedDurations: Error thrown : ${z.message}`)}};var n;(function(x){x.EditCommit="EDITCOMMIT";x.SignalSent="SIGNALSENT";x.AnnotationReceived="ANNOTATIONRECEIVED";x.CalculationStart="CALCULATIONSTART";x.CalculationEnd="CALCULATIONED";x.ModelUpdated="MODELUPDATED";x.PreviewRendered="PREVIEWRENDERED";x.UserInputArrived="USERINPUTARRIVED";x.PreviewRemovedWithCSE=
"PREVIEWREMOVEDWITHCSE"})(n||(n={}));Object(t.b)("FormulaByExampleFlowMarks",n);const w=x=>c.HelperMethods.sXc&&b.a.oob&&f.a.f4(x),r=(x,B,z)=>`${x}_${B+(z?"_cached":"")}`,u=(x,B,z)=>{window.performance.measure(x,B,z);const A=window.performance.getEntriesByName(x);if(A[A.length-1])return B=A[A.length-1].duration,performance.clearMeasures(x),B;d.ULS.sendTraceTag(526984791,0,15,`FormulaByExampleTelemetryGenerator.measureTime: could not find performance entry for measure: ${x}, startMark: ${B}, endMark: ${z}`);
return-1},y=x=>x.replace(RegExp("[0-9a-zA-Z]","g"),B=>"a"<=B&&"z">=B?"a":"A"<=B&&"Z">=B?"A":"0"<=B&&"9">=B?"9":B)},848:function(t,C,a){t=a(0);var c=a(15),b=a(1),d=a(187),f;(function(A){A[A.UserEditedInTable=0]="UserEditedInTable";A[A.FormulaByExampleNoTrigger=1]="FormulaByExampleNoTrigger";A[A.FlowInterrupted=2]="FlowInterrupted";A[A.FormulaByExampleFullTrigger=3]="FormulaByExampleFullTrigger";A[A.HadCachedSuggestion=4]="HadCachedSuggestion";A[A.NoCachedSuggestion=5]="NoCachedSuggestion";A[A.PreCalcPreviewRejected=
6]="PreCalcPreviewRejected";A[A.WaitingForCalcResult=7]="WaitingForCalcResult";A[A.PostCalcPreviewRejected=8]="PostCalcPreviewRejected";A[A.SuggestionDidntMatch=9]="SuggestionDidntMatch";A[A.SuggestionMatched=10]="SuggestionMatched";A[A.PreviewShouldBeShown=11]="PreviewShouldBeShown";A[A.SignalSent=12]="SignalSent";A[A.NoSignalSent=13]="NoSignalSent";A[A.AnnotationReceived=14]="AnnotationReceived";A[A.NoFormulaFound=15]="NoFormulaFound";A[A.FormulaFound=16]="FormulaFound";A[A.WorkbookClosed=17]="WorkbookClosed";
A[A.UnexpectedTransition=18]="UnexpectedTransition"})(f||(f={}));Object(t.b)("FormulaByExampleFlowState",f);const e=new Map([[f.UserEditedInTable,[f.FormulaByExampleNoTrigger,f.FormulaByExampleFullTrigger]],[f.FormulaByExampleFullTrigger,[f.FlowInterrupted,f.NoCachedSuggestion,f.HadCachedSuggestion]],[f.NoCachedSuggestion,[f.NoSignalSent,f.SignalSent]],[f.HadCachedSuggestion,[f.PreCalcPreviewRejected,f.WaitingForCalcResult]],[f.PreCalcPreviewRejected,[f.NoSignalSent,f.SignalSent]],[f.WaitingForCalcResult,
[f.NoSignalSent,f.SignalSent]]]),k=new Set([f.FormulaByExampleNoTrigger,f.FlowInterrupted,f.NoSignalSent,f.SignalSent]),l=new Map([[f.PreCalcPreviewRejected,[f.SuggestionDidntMatch,f.SuggestionMatched]]]),m=new Set([f.SuggestionDidntMatch,f.SuggestionMatched]),v=new Map([[f.WaitingForCalcResult,[f.PostCalcPreviewRejected,f.SuggestionDidntMatch,f.SuggestionMatched]],[f.SuggestionDidntMatch,[f.PostCalcPreviewRejected,f.PreviewShouldBeShown]],[f.SuggestionMatched,[f.PostCalcPreviewRejected,f.PreviewShouldBeShown]]]),
n=new Set([f.PostCalcPreviewRejected,f.PreviewShouldBeShown]),w=new Map([[f.SignalSent,[f.AnnotationReceived]],[f.AnnotationReceived,[f.NoFormulaFound,f.FormulaFound]]]),r=new Set([f.NoFormulaFound,f.FormulaFound]);class u{constructor(A,I,F){this.currentState=A;this.GEj=I;this.hzh=F}Mta(A){const I=this.GEj.get(this.currentState);return I&&I.includes(A)?(this.currentState=A,!0):!1}get isActive(){return!this.hzh.has(this.currentState)}vfd(){return f[this.currentState]}}Object(t.a)(u,"FormulaByExampleStateMachine",
null,[]);class y{constructor(A,I,F,U){this.jKc=!1;this.qJi=U;this.Onc=new u(0,e,k);this.fua={ui:A,nZg:I,Whj:F,Ikc:null,OSe:!1,qNd:!1,Z3f:!1,PSe:{}}}get Aji(){return this.jKc}set ui(A){this.fua.ui=A}Mta(A,I){17===A?this.OG():(this.M6b(A,I),this.eIg())}OG(){this.qJi(this.fua)}M6b(A,I){var F,U;this.Onc.Mta(A)?this.AOi(A):(null===(F=this.Qob)||void 0===F?0:F.Mta(A))?this.WFi(A):(null===(U=this.Uwc)||void 0===U?0:U.Mta(A))?this.nRi(A,I):this.FMi(A,I);(A=this.EZe(A))&&this.Gke(A,I)}AOi(A){switch(A){case 2:this.fua.OSe=
!0;break;case 6:this.Qob=new u(A,l,m);break;case 7:this.Qob=new u(A,v,n);break;case 12:this.jKc=!0,this.fua.Z3f=!0,this.Uwc=new u(A,w,r)}}WFi(A){switch(A){case 9:this.fua.qNd=!1;break;case 10:this.fua.qNd=!0}}nRi(A,I){switch(A){case 14:this.jKc=!1;break;case 16:this.fua.Ikc=I?I.Ikc:null}}FMi(A,I){this.Gke(this.EZe(18),{reason:`${`Tried to change state from ${this.jnj()} to ${f[A]}`}.${this.r0e(I)}`});this.OG()}eIg(){var A,I;this.Onc.isActive||(null===(A=this.Qob)||void 0===A?0:A.isActive)||(null===
(I=this.Uwc)||void 0===I?0:I.isActive)||this.OG()}Gke(A,I){if(I=this.r0e(I))A.Y1a||(A.Y1a=""),A.Y1a+=I;I=A.name;A=Object(d.b)(A,["name"]);this.fua.PSe[I]=A}r0e(A){return null!=A&&null!=A.reason?" "+A.reason:""}jnj(){var A,I;const F=`OriginStateMachine: ${this.Onc.isActive?this.Onc.vfd():"NotActive"}`,U=`CalcStateMachine: ${(null===(A=this.Qob)||void 0===A?0:A.isActive)?this.Qob.vfd():"NotActive"}`;A=`SignalStateMachine: ${(null===(I=this.Uwc)||void 0===I?0:I.isActive)?this.Uwc.vfd():"NotActive"}`;
return`[${F}, ${U}, ${A}]`}EZe(A){switch(A){case 5:return{name:"CachedSuggestion",value:!1};case 4:return{name:"CachedSuggestion",value:!0};case 6:return{name:"PreviewShown",value:!1,Y1a:"Before calling calc evaluation"};case 8:return{name:"PreviewShown",value:!1,Y1a:"After returning from Calc"};case 9:return{name:"SetCellMatchedSuggestion",value:!1};case 10:return{name:"SetCellMatchedSuggestion",value:!0};case 11:return{name:"PreviewShown",value:!0};case 8:return{name:"PreviewShown",value:!1,Y1a:"After returning from Calc"};
case 15:return{name:"FormulaFound",value:!1};case 16:return{name:"FormulaFound",value:!0};case 18:return{name:"UnexpectedTransition",value:!0}}return null}}Object(t.a)(y,"FormulaByExampleFlowDataAggregator",null,[]);a.d(C,"b",function(){return-1});a.d(C,"a",function(){return x});class x{static getInstance(A){this.instance||(b.EwaSettings.isChangeGateEnabled("OfficeVSO:7041480_FormulaByExampleFlowAggregatorFixed")?this.instance=B.getInstance(A):this.instance=z.getInstance(A));return this.instance}}
Object(t.a)(x,"FormulaByExampleFlowsTrackerFactory",null,[]);class B{constructor(A){this.nextId=1;this.G$e=this.$Mb=0;this.yia=new Map;this.bUd=new Map;this.cYf=new Map;this.rof=new Map;this.xwe=new Map;this.jjf=new Map;this.Ec=()=>{const I=this.OSh();if(0!==I.size){this.$.sendBeaconTraceTag(526984790,50,!1,`some pending FBE flows were not resolved by workbook closure. Total flows amount in sessions: ${this.$Mb}, Unresolved flows amount: ${I.size}, pending flows: ${[...I].join()}, interrupted flows amount ${this.G$e}`);
for(const F of I)this.kt(F,17)}};this.gGj=I=>{const F=I.ui;var U=I.nZg;const X=I.Whj,S=I.Ikc,H=I.OSe,D=I.qNd,J=I.Z3f;I=I.PSe;const M=this.jjf.get(U);if(!M&&S||M&&M!==S)this.Rjd(this.xwe,U),this.jjf.set(U,S);D&&this.Rjd(this.rof,U);H&&this.G$e++;J&&this.$Mb++;U={["flowId"]:F,["columnKey"]:U,["rowNumber"]:X,["flowDataAggergation"]:I,["setCellsInColumn"]:this.cYf.get(U)||0,["suggestionChangesInColumn"]:this.xwe.get(U)||0,["matchedSuggestionsInColumn"]:this.rof.get(U)||0};c.ULS.sendTraceTag(512365781,
0,50,`FormulaByExampleFlowsTracker.summarizeFlowOverallData: Flow Aggregation results: ${JSON.stringify(U)}`);this.yia.delete(F)};this.$=A;this.$.kk(this.Ec)}static getInstance(A){B.instance||(B.instance=new B(A));return B.instance}ZZe(){const A=this.nextId++,I=this.yia.get(-1);I?(I.ui=A,this.yia.set(A,I),this.yia.delete(-1)):c.ULS.sendTraceTag(512503829,0,15,`FormulaByExampleFlowsTracker.getNewFlowId: on flowId ${A} called getNewFlowId without having matched anonymousFlow`);return A}VBf(A,I,F){this.kt(-1,
2);this.yia.delete(-1);A=this.PJh(A,I);this.Rjd(this.cYf,A);this.yia.set(-1,new y(-1,A,F,this.gGj))}kt(A,I,F){if(this.yia.has(A)){var U=this.yia.get(A);U?U.Mta(I,F):c.ULS.sendTraceTag(512503828,0,10,`FormulaByExampleFlowsTracker.enterFlowToNewState: on flowId ${A} flowIdsToAggregatorsMap.has returned true but flowIdsToAggregatorsMap.get didn't find the wanted aggregator object`)}}PJh(A,I){let F=this.bUd.get(A);void 0===F&&(F=this.bUd.size,this.bUd.set(A,F));return F+"_"+I}OSh(){const A=new Set;for(const [I,
F]of this.yia)F.Aji&&A.add(I);return A}Rjd(A,I){A.has(I)||A.set(I,0);A.set(I,A.get(I)+1)}}Object(t.a)(B,"FormulaByExampleFlowsTracker",null,[733]);class z{constructor(A){this.nextId=1;this.T8b=new Set;this.$Mb=0;this.Ec=()=>{let I=this.T8b.size;0!==I&&this.$.sendBeaconTraceTag(526984790,50,!1,"some pending FBE flows were not resolved by workbook closure. Total flows amount in sessions: {0}, Unresolved flows amount: {1}, pending flows: {2}",this.$Mb,I,[...this.T8b].join())};this.$=A;this.$.kk(this.Ec)}static getInstance(A){z.instance||
(z.instance=new z(A));return z.instance}VBf(){}kt(A,I){switch(I){case 12:this.Epj(A);break;case 14:this.Fpj(A)}}ZZe(){return this.nextId++}Epj(A){this.T8b.add(A);this.$Mb++}Fpj(A){this.T8b.delete(A)}}Object(t.a)(z,"FormulaByExampleFlowsTrackerDeprecated",null,[733])},931:function(t,C,a){function c(O){return k.Range.Uc(O.row+1,O.col+1)}t=a(0);var b=a(7),d=a(15),f=a(814),e=a(5),k=a(24),l=a(33),m=a(162),v=a(8);class n{constructor(O,ea=null,R){this.status=O;this.nZc=ea;this.qpc=R}}Object(t.a)(n,"FormulaByExampleFormulaEvalResult",
null,[]);var w=a(22),r=a(21),u=a(1),y=a(848);class x{constructor(O,ea,R,oa){this.CB=!1;this.$=O;this.calcManager=ea;this.CB=oa;this.ug=R;this.Nn=y.a.getInstance(this.$);this.gridView=r.g(this.$)}$pj(O,ea=null,R=!1,oa){const pa=O.range.Ge(this.gridView.gi);return pa?this.bLe(O,pa,ea).then(Pa=>{this.CB&&!R&&O.ui&&Object(f.f)("CALCULATIONED",O.ui,oa);if(2===Pa.status)return Pa;d.ULS.sendTraceTag(537161881,0,50,"FormulaByExampleModelUpdater:setFormulaPreviewOnRangeModel: evalFormulaRangeOnClone CSE: Result received from calc.");
return this.tRj(Pa,R,O.ui,oa)}).catch(Pa=>{Object(f.g)(O,`failed to setFormulaPreviewOnRangeModel, error in calc API: ${Pa.toString()}`,this.Nn,8);return Promise.reject(`FormulaByExampleModelUpdater:setFormulaPreviewOnRangeModel: Unable to EvalFormulaRange, e: ${Pa.toString()}`)}):(Object(f.g)(O,"Annotation range does not intersect loaded range",this.Nn,6),Promise.reject("FormulaByExampleModelUpdater:setFormulaPreviewOnRangeModel: Annotation range does not intersect loaded range."))}bLe(O,ea,R=null){R=
x.qCh(R);this.Nn.kt(O.ui,7);return this.calcManager.Esb(R,ea,O.originCell,O.formula).then(oa=>{if(!this.dhi(oa))return Object(f.g)(O,"Result object from EvalOnClone API is empty or null.",this.Nn,8),new n(2);if(!this.pIg(oa,O))return d.ULS.sendTraceTag(527005663,0,50,"FormulaByExampleModelUpdater:EvalFormulaRangeOnClone: Formula results from Calc.ts had errors."),new n(2);const pa=this.cVj(oa.results,O);if(!pa.success)return Object(f.g)(O,`Evaluated results from calc do not match the user data in the grid or had errors from calc. reason: ${pa.reason}`,
this.Nn,8),d.ULS.sendTraceTag(537161880,0,50,"FormulaByExampleModelUpdater:EvalFormulaRangeOnClone:Formula results from Calc.ts do not match grid data."),new n(2);this.Nn.kt(O.ui,11);d.ULS.sendTraceTag(537161879,0,50,"FormulaByExampleModelUpdater:EvalFormulaRangeOnClone: EvalFormulaRange CSE: Result received from calc.");return new n(0,oa.results,pa.qpc)}).catch(oa=>{Object(f.g)(O,`failed to EvalFormulaRangeOnClone, error in calc API: ${oa.toString()}`,this.Nn,8);return Promise.reject(`FormulaByExampleModelUpdater:EvalFormulaOnRange: Unable to EvalFormulaRange, e: ${oa.toString()}`)})}dKg(O,
ea){if(O)for(const R of O)if(this.LTe(R)&&(O=c(R.value[0]),O=this.gridView.Vb(O))){O=O.cell;if(excelOnlineCalc.util.isSuccess(R)){const oa=B(R);O.text=oa.value}O.formulaBarText=ea}}static qCh(O){const ea=R=>({row:R.cell.rQ,column:R.cell.qQ,Gk:R.cell.Gk,text:R.cell.text});return O?O.map(ea):null}pIg(O,ea){if(u.EwaSettings.isChangeGateEnabled("OfficeVSO:6669310_FBEShowsSuggestionsWithCalcFailures"))return!0;for(const R of O.results){const {isSuccess:oa,RKe:pa,reason:Pa}=this.LTe(R);if(!oa)return Object(f.g)(ea,
`Calc failed to evaluate formula. reason json: ${Pa} did result in error for formula output (#VALUE, #REF etc..): ${pa}`,this.Nn,8),!1}return!0}dhi(O){return(O=O.results)&&O.length?!0:!1}LTe(O){var ea=excelOnlineCalc.util.isSuccess(O);return ea&&8===B(O).kind?(ea=c(O.value[0]),(ea=this.gridView.Vb(ea))&&ea.cell.text&&d.ULS.shipAssertTag(537161878,0,!1,"FormulaByExampleModelUpdater:FormulaCalculationSucceeded: formula evaluation failed, bad formula provided"),{isSuccess:!1,RKe:!0,reason:JSON.stringify(O.value)}):
{isSuccess:ea,RKe:!1,reason:JSON.stringify(O.reason)}}tRj(O,ea,R,oa){var pa=O.nZc;for(const Z of pa)if(excelOnlineCalc.util.isSuccess(Z)){var Pa=Z.value[0];pa=B(Z);Pa&&pa?(Pa=c(Pa),(Pa=this.gridView.Vb(Pa))?(Pa.cell.NDd=pa.value,O.status|=1):O.status|=2):O.status|=2}else O.status|=2;this.CB&&!ea&&R&&Object(f.f)("MODELUPDATED",R,oa);return O}cVj(O,ea){let R=null,oa=!1,pa=!1,Pa=!1,Z=!1,Ra=!1,Ga=!1,Ba=!1;for(const ja of O){if(!excelOnlineCalc.util.isSuccess(ja)){if(u.EwaSettings.isChangeGateEnabled("OfficeVSO:6669310_FBEShowsSuggestionsWithCalcFailures"))if(O=
ja.reason,"Unavailable"===O.kind){Pa=!0;O=k.Range.Uc(O.cell.row+1,O.cell.col+1);this.gridView.nK(O)&&(Z=!0,this.gridView.Yd.bgc(O)?Ra=!0:Ga=!0);continue}else R=null!==R&&void 0!==R?R:JSON.stringify({kind:O.kind,innerKind:O.innerKind});R=null!==R&&void 0!==R?R:"failure in calc"}var fa=B(ja);if(8===fa.kind){Ba=!0;continue}O=c(ja.value[0]);var Y=this.gridView.Vb(O);Y||(R=null!==R&&void 0!==R?R:"formatted grid cell is null");const ca=Y.text;if(ca&&(fa=fa.value,u.EwaSettings.isChangeGateEnabled("OfficeVSO:6327953_FormatOutputResultsOfFBEDeprecated")||
(Y=this.ug.wTe(fa,Y.cell.Gk,Y.cell.wJ,Y.cell.FAa,Y.cell.zha),Y.success&&(fa=Y.Nx)),Y=w.a.equals(ca,fa.toString(),!1),Y||(d.ULS.sendTraceTag(512350163,0,50,`FormulaByExampleModelUpdater.validateCalcResultMatchModelData: Cell data didn't match suggestion output. 
           CellData: ${Object(f.a)(ca)}, SuggestionOutput: ${Object(f.a)(fa.toString())},
           SuggestedFormula: ${ea.anonymizedFormula}}`),R=null!==R&&void 0!==R?R:"data strings do not match"),O.equals(ea.originCell)&&(oa=!0,pa=Y),oa&&R))break}pa?this.Nn.kt(ea.ui,10):this.Nn.kt(ea.ui,9);return R?{success:!1,reason:R}:{success:!0,qpc:{["hasUnavailableCells"]:Pa,["hasUnexpectedUnavailableCellsInViewport"]:Ga,["hasHiddenRows"]:Ra,["hasUnavailableCellsInViewport"]:Z,["hasErrorCells"]:Ba}}}}Object(t.a)(x,"FormulaByExampleModelUpdater",null,[]);const B=O=>{if(O=O.value[1])return{kind:O.kind,
value:"_valueXL"in O?O._valueXL.toString():"type"in O?v.a.I7c[O.type-1]:O.value}};var z;(function(O){O.accept="ACCEPT";O.decline="DECLINE";O.ignore="IGNORE"})(z||(z={}));Object(t.b)("PreviewOutcome",z);var A;(A||(A={})).unseen="UNSEEN";Object(t.b)("EntryState",A);const I=Object.assign(Object.assign({},A),z);class F{constructor(O){this.state=I.unseen;this.pJb=0;this.suggestion=O}Q7h(){this.pJb+=1}}Object(t.a)(F,"SuggestionEntryInternal",null,[]);class U extends Map{$$b(O){return(O=this.getKey(O))?
this.has(O)?this.get(O):null:null}a0b(O){const ea=this.getKey(O);if(!ea)return null;this.set(ea,new F(O));return this.get(ea)}tTj(O){const ea=this.$$b(O);ea&&(ea.suggestion=O);return ea}}Object(t.a)(U,"SuggestionsCache",Map,[]);class X{constructor(O,ea){this.formula=O;this.pJb=this.state=0;this.WE=ea}}Object(t.a)(X,"FormulaByExampleSuggestionsCacheEntry",null,[]);class S extends U{constructor(O,ea){super();this.calcManager=O;this.VJ=ea}a0b(O){var ea=!1;const R=super.$$b(O);if(!R||(ea=R.suggestion.formula!==
O.formula))return ea&&d.ULS.sendTraceTag(523842004,306,50,`FormulaByExampleSuggestionsCache.cacheSuggestion: formula changed from last cache entry, overriding cache entry. Last example count: ${R.suggestion.WE}, current: ${O.WE}`),d.ULS.sendTraceTag(537161877,306,50,`FormulaByExampleSuggestionsCache.cacheSuggestion: saving suggestion for table range. tableRange: ${O.table.usedRange}, columnNumber: ${O.column}, examplesCount ${O.WE}, hasPreviousSuggestion: ${this.has(this.getKey(O))}`),(ea=super.a0b(O))||
d.ULS.sendTraceTag(528889932,306,15,"SuggestionsCache.cacheSuggestion: failed to cache table suggestion due to getTableColumnKey failure."),this.VJ.uda(O.originCell,3),ea;R.suggestion.WE!==O.WE&&(d.ULS.sendTraceTag(523842003,306,50,`FormulaByExampleSuggestionsCache.cacheSuggestion: formula didn't change from the last cache entry, but number of examples changed. Last example ${R.suggestion.WE}, current: ${O.WE}`),this.VJ.uda(O.originCell,4),O.dca.WE=R.suggestion.dca.WE);return this.tTj(O)}$$b(O){const ea=
super.$$b(O);return w.a.equals(null===ea||void 0===ea?void 0:ea.suggestion.formula,O.formula,!0)?ea:null}Z1e(O,ea){O=this.B2e(O,ea);return O?this.get(O):(d.ULS.sendTraceTag(528889931,306,15,"FormulaByExampleSuggestionsCache.getTableCachedSuggestion: failed to get cached table suggestion due to getTableColumnKey failure."),null)}getKey(O){return this.B2e(O.table,O.column)}B2e(O,ea){const R=this.calcManager.W3a(O);if(!R)return null;const oa=O.usedRange,pa=ea-oa.left;(0>pa||pa>=R.count)&&d.ULS.sendTraceTag(537161876,
306,10,"FormulaByExampleSuggestionCache.getUniqueTableColumnIdentifier: invalid inputs: tableRange: {0}, columnNumber: {1}.",oa,ea);return(ea=R.na(pa))?O.name+"_"+ea:null}}Object(t.a)(S,"FormulaByExampleSuggestionsCache",U,[]);class H{constructor(O){this.calcManager=O;this.cache=new Map}Z1e(O,ea){O=this.IXh(O,ea);return O?this.cache.get(O):(d.ULS.sendTraceTag(523842E3,306,15,"FormulaByExampleSuggestionsCache.getTableCachedSuggestion: failed to get cached table suggestion due to getTableColumnKey failure."),
null)}IXh(O,ea){return(ea=this.JXh(O,ea))?O.name+"_"+ea:null}JXh(O,ea){const R=this.calcManager.W3a(O);if(!R)return null;O=O.usedRange;const oa=ea-O.left;(0>oa||oa>=R.count)&&d.ULS.sendTraceTag(537161876,306,10,`FormulaByExampleSuggestionsCache.GetTableColumnName: invalid inputs: tableRange: ${O}, columnNumber: ${ea}.`);return R.na(oa)}}Object(t.a)(H,"FormulaByExampleSuggestionsCacheDeprecated",null,[]);var D=a(261);z=a(721);var J=a(695);class M extends z.a{constructor(){super();this.rows=null;this.column=
0;this.generatedFormula=this.formulas=null;this.resultKind=this.invocationMethod=this.stateID=0;this.errorMessage=this.guid=null;this.H_=Object.assign(new J.a,{T_:M.getTypeName(),B_:M.Pd()})}static getTypeName(){return"AugLoop_FormulaByExample_FormulaByExampleAnnotation"}static Pd(){return["AugLoop_Core_Annotation"]}}Object(t.a)(M,"FormulaByExampleAnnotation",z.a,[]);var G=a(65),T=a(212);class K extends M{constructor(O,ea,R){super();Object.assign(this,ea);this.$=O;R&&(this.MTb=R.range,this.JRc=R.idf);
this.dca={ui:this.ui,WE:this.WE,originCell:this.originCell,anonymizedFormula:this.anonymizedFormula}}static Q3e(O){return parseInt(O,10)}set ui(O){this.vHc=O}get ui(){void 0===this.vHc&&(this.vHc=K.Q3e(this.guid));return this.vHc}get formula(){var O;void 0===this.jVa&&(this.jVa=null===(O=this.generatedFormula)||void 0===O?void 0:O.formula)&&"="!==this.jVa.charAt(0)&&(d.ULS.sendTraceTag(524833933,306,50,"FormulaByExampleSuggestion.formula: appending = sign as formula prefix."),this.jVa=`=${this.jVa}`);
return this.jVa}set WE(O){this.LGc=O}get anonymizedFormula(){var O;void 0===this.O5d&&(this.O5d=null===(O=this.generatedFormula)||void 0===O?void 0:O.anonymizedFormula);return this.O5d}get WE(){void 0===this.LGc&&(this.LGc=this.rows.length);return this.LGc}set originCell(O){this.MTb=O}get originCell(){void 0===this.MTb&&(d.ULS.sendTraceTag(524833932,306,10,`FormulaByExampleSuggestion.originCell: origin cell is not defined - falling back to first cell of annotation range. flowId: ${this.ui}`),this.MTb=
k.Range.Uc(this.rows[0],this.column));return this.MTb}get xZd(){void 0===this.JRc&&(this.JRc=null!==this.table);return this.JRc}get table(){void 0===this.hlb&&(this.hlb=Object(r.g)(this.$).Db.Yj(this.originCell,!1));return this.hlb}get range(){if(void 0===this.Yw){const O=Object(m.a)(this.table);this.Yw=new k.Range(O.top,this.column,O.bottom,this.column,!0,!0)}return this.Yw}}Object(t.a)(K,"FormulaByExampleSuggestion",M,[]);var L=a(120),V=a(972),W=a(973),da;(function(O){O[O.Unknown=0]="Unknown";O[O.Permanent=
1]="Permanent";O[O.TokenExpired=2]="TokenExpired";O[O.ModelWorkflowNotSupported=3]="ModelWorkflowNotSupported";O[O.WorkbookClosed=4]="WorkbookClosed"})(da||(da={}));Object(t.b)("AugmentationLoopCloseReason",da);a.d(C,"a",function(){return qa});class qa{constructor(O,ea,R,oa,pa){this.TH=this.VJ=this.byc=this.gkc=null;this.hMa=this.CB=!1;this.JDd=null;this.cRd=!1;this.q2a=null;this.N1f=!1;this.SGi=Pa=>{d.ULS.sendTraceTag(520987789,306,50,`FormulaByExampleManager.onCloseCallback: closeReason = ${da[Pa]}`)};
this.JTe=(Pa,Z)=>{d.ULS.sendTraceTag(528758222,306,50,"FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation received.");(Pa=Z.rJ)?(Pa=new K(this.$,Pa,this.YXi(K.Q3e(Pa.guid))),d.ULS.sendTraceTag(526984792,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: received annotation's flowId: ${Pa.ui}.`),this.Nn.kt(Pa.ui,14),this.CB&&!this.hMa&&Object(f.f)("ANNOTATIONRECEIVED",Pa.ui),null!=Pa.errorMessage?(d.ULS.sendTraceTag(527005666,306,10,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation arrived with error message: ${Pa.errorMessage}, flowId: ${Pa.ui}`),
this.Nn.kt(Pa.ui,15,{reason:"Annotation arrived with error message"})):Pa.formula?(this.Nn.kt(Pa.ui,16,{Ikc:Pa.formula}),Pa.xZd&&this.unb?(this.TH=Pa,Z=this.byc.a0b(Pa),this.N1f&&1===Pa.invocationMethod?d.ULS.sendTraceTag(523850754,306,50,"FormulaByExampleManager.formulaByExampleAnnotationHandler: session supports suggestions from cache only. returning early after caching suggestion."):Pa.WE<V.a?d.ULS.sendTraceTag(528758220,306,50,"FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation does not have enough examples to prompt a suggestion."):
(d.ULS.sendTraceTag(527005665,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation with formula suggestion arrived. trying to suggest/apply it. flowID: ${Pa.ui}`),0===Pa.invocationMethod?this.Zpj(Pa):this.Y1f(Z)&&this.I$f(Z,!1))):this.Msi(Pa)):(d.ULS.sendTraceTag(528758221,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation does not have any formula suggestions. flowId: ${Pa.ui}`),this.VJ.uda(Pa.originCell,2),this.Nn.kt(Pa.ui,15))):d.ULS.sendTraceTag(537161922,
306,15,"FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation is null.")};this.Tlj=()=>{d.ULS.sendTraceTag(537161889,306,50,"FormulaByExampleManager.SendByExampleFeedback: opening send feedback dialog after click on card.");const Pa={};Pa[e.a.rU]="FormulaByExampleCard";this.$.ud(802602464,0,8,Pa)};this.jRi=Pa=>{this.cRd=!0;d.ULS.sendTraceTag(537161888,306,50,`FormulaByExampleManager.OnShowFormula: user clicked ShowFormula button in the card for flow ${Pa}`)};this.j2h=Pa=>{d.ULS.sendTraceTag(528758219,
306,50,"FormulaByExampleManager.HandleNewBlocksDuringPreview: new block arrived during preview mode.");const Z=Pa.fd.block;var Ra=m.a(this.TH.table);const Ga=this.TH.range.Ge(Z.rf);Ra=(new k.Range(Ra.top,Ra.left,Ra.bottom,Ra.right,!0,!0)).Ge(Z.rf);const Ba=[];for(let fa of this.gridView.Nua(Ra,Z))Ba.push(fa);d.ULS.sendTraceTag(537161886,306,50,`FormulaByExampleManager.HandleNewBlocksDuringPreview: putting skeleton for preview cells in new block ${Pa.fd.hash}.`);this.cYd(Ga,!0);this.cLe(this.TH,Ba).then(fa=>
{d.ULS.sendTraceTag(537161885,306,50,`FormulaByExampleManager.HandleNewBlocksDuringPreview: putting calculated data into model and demanding re-render for block ${Pa.fd.hash}.`);this.cYd(Ga,!1);this.iR.mof(Pa.fd.block);d.ULS.sendTraceTag(512508567,306,50,`FormulaByExampleManager.handleNewBlocksDuringPreview: new FormulaByExample suggestion block rendered during preview. results: ${JSON.stringify({["flowId"]:this.TH.ui,["originalFlowId"]:this.TH.dca.ui,["formulaAnonymized"]:this.TH.anonymizedFormula,
["originalFormulaAnonymized"]:this.TH.dca.anonymizedFormula,["annotationRange"]:this.TH.range.toString(),["previewCellsMetadata"]:fa.qpc})}`);return!0}).catch(fa=>{Object(f.g)(this.TH,`Exception when rendering new block during preview. ${fa}`);d.ULS.sendTraceTag(537161884,306,50,`FormulaByExampleManager.HandleNewBlocksDuringPreview: caught exception: ${fa}.`)})};this.HOf=()=>{this.$.userOperationManager.Co(this.rAd);this.rAd=null};this.Ymc=(Pa,Z)=>{0==Z.Lq&&(this.hMa&&this.JDd.Gva(`UserOperation: ${L.a(Z.xf.operation.operationName)}`),
this.$.userOperationManager.Co(this.Ymc))};this.gMi=(Pa,Z)=>{d.ULS.sendTraceTag(528023709,306,50,`FormulaByExampleManager.onImmediateUndo: undo operation queued following a formula by example suggestion application. flowId=${Pa} originalFlowId=${Z}`)};this.$=O;this.unb=l.a.f4(this.$);this.N1f=u.EwaSettings.isChangeGateEnabled("OfficeVSO:6169955_ShowCachedFormulaByExampleSuggestionsOnly");this.augmentationLoopManager=ea;this.calcManager=R;this.ug=oa;this.q2a=new Map;this.gridView=r.g(this.$);this.VJ=
pa;this.Nn=y.a.getInstance(this.$);this.unb&&(this.iR=this.gridView.iR,this.MDd=!1);l.a.ifc(this.$)?this.init():d.ULS.sendTraceTag(537161923,306,10,"FormulaByExampleManager.Ctor: not expected to be constructed when FG is off.")}XSi(O,ea,R){if(R&&this.unb){this.MDd=!1;var oa=this.gridView.Db.Yj(O,!1);if(oa=this.byc.Z1e(oa,O.left)){this.Nn.kt(ea,4);var pa=this.Y1f(oa);pa.value||(this.Nn.kt(ea,6,{reason:pa.reason}),this.FVj(ea,oa.suggestion,O))}else this.Nn.kt(ea,5);oa&&pa.value?(oa.suggestion.ui=ea,
oa.suggestion.originCell=O,d.ULS.sendTraceTag(529109774,306,50,"FormulaByExampleManager.onTableInput: A cached formula suggestion found for current input."),this.I$f(oa,!0)):this.q2a.set(ea,{range:O,idf:R})}else d.ULS.shipAssertTag(524940241,306,l.a.R5a(this.$),"FormulaByExampleManager.onUserInput: expected to be called on range only in dark experiment."),this.q2a.set(ea,{range:O,idf:R})}FVj(O,ea,R){u.EwaSettings.isChangeGateEnabled("OfficeVSO:7041480_FormulaByExampleFlowAggregatorFixed")&&this.calcManager.evalFormula(ea.formula,
R,G.d(this.$.pa),excelOnlineCalc.calc.evalFormulaFormatOrigin()).then(oa=>{w.a.equals(this.gridView.Vb(R).text,oa.value.value.toString(),!1)?this.Nn.kt(O,10):this.Nn.kt(O,9)}).catch(oa=>{oa=`Failed to evalFormula, error in calc API: ${oa.toString()}`;d.ULS.sendTraceTag(512341207,306,50,`FormulaByExampleMangaer.verifySuggestionOnEditedCell: ${oa}`);this.Nn.kt(O,9,{reason:oa})})}dispose(){this.$.userOperationManager.Co(this.Ymc);this.HOf()}init(){qa.NEe=u.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.FBEDarkExperimentRowsAboveEditedCell",
1);qa.wah=u.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.FBEDarkExperimentColumnsBeforeEditedCell",5);const {FormulaByExampleAutoSuggestActor:O}=a(1310);u.EwaSettings.isChangeGateEnabled("OfficeVSO:6496246_FormulaByExampleMigrationToNewALAPI")?this.augmentationLoopManager.register(this.augmentationLoopManager.xHh().zpj().zoj(this.SGi).activateAnnotation({annotationType:M.getTypeName(),Vyb:!1,LCb:this.JTe}).build()):(this.augmentationLoopManager.activateAnnotation(M.getTypeName()),this.augmentationLoopManager.bP(M.getTypeName(),
this.JTe));this.CB=Object(f.b)(this.$);new O(this.$,this.calcManager,this.CB);this.byc=new S(this.calcManager,this.VJ);this.unb&&(this.gkc=new x(this.$,this.calcManager,this.ug,this.CB));d.ULS.sendTraceTag(528758223,306,50,"FormulaByExampleManager.init: init complete.")}YXi(O){if(!this.q2a.has(O))return null;const ea=this.q2a.get(O);this.q2a.delete(O);return ea}Msi(O){d.ULS.sendTraceTag(524940240,306,50,`FormulaByExampleManager.logAndCacheExperimentResult: annotation received for a given flow. tableOrRangeBucket: ${O.xZd?
"Table":"Range"}, exampleCountForSuggestion: ${O.WE}, flowId: ${O.ui}`);O.xZd&&this.byc.a0b(O)}Zpj(O){this.gkc.bLe(O,O.range,null).then(ea=>{this.vVc(O,1===ea.status?ea.nZc:null);return null}).catch(()=>{d.ULS.sendTraceTag(537161921,306,50,"FormulaByExampleManager.setFormulaOnRangeExplicit: client estimation failed for explicit by example flow.");this.vVc(O,null)})}I$f(O,ea){d.ULS.sendTraceTag(527713160,306,50,`FormulaByExampleManager.tryDisplayFormulaSuggestionPreview: starting flow to show a formula suggestion. isFromCache: ${ea}`);
const R=O.suggestion;this.CB&&!this.hMa&&Object(f.f)("CALCULATIONSTART",R.ui,ea);const oa=this.cLe(R,null,ea),pa=oa.then(()=>this.iR.ddb(R.range,this.j2h).then(Pa=>{this.hMa=!0;this.JDd=Pa;this.$.userOperationManager.Hr(this.Ymc);this.CB&&T.a(()=>{Object(f.f)("PREVIEWRENDERED",R.ui,ea);const Z=Object(f.e)(ea,R.ui);d.ULS.sendTraceTag(529109772,306,50,`FormulaByExampleManager.TryDisplayFormulaSuggestionPreview: durations for preview shown flow: ${JSON.stringify(Z)}`)},this.$.la);this.VJ.show(R.formula,
R.range.toString(),()=>Pa.OWb("CardUI"),()=>Pa.C4b("CardUI"),this.Tlj,()=>this.jRi(R.ui),void 0,R.originCell);this.VJ.uda(R.originCell,0);return Pa.Ogj}));Promise.all([oa,pa]).then(Pa=>{this.MDd=!0;this.x2h(Pa[0],Pa[1],O,ea)}).catch(Pa=>{Object(f.g)(R,`Failed to show formula preview due to a promise (model update or preview render) rejection. rejection reason: ${Pa}`);d.ULS.sendTraceTag(537161920,306,15,`FormulaByExampleManager.TryDisplayFormulaSuggestionPreview: failed to show formula preview due to promise rejection. rejection reason: ${Pa}`);
this.VJ.uda(R.originCell,5,Pa);O.state=I.ignore})}cLe(O,ea=null,R){return this.gkc.$pj(O,ea,this.hMa,R).then(oa=>{d.ULS.sendTraceTag(537161887,306,50,`FormulaByExampleManager.EvaluateFormulaAndUpdateModel: model update completed. result: ${oa.status}.`);switch(oa.status){case 3:case 1:return 3===oa.status&&Object(f.g)(O,"Preview shown, but only partially. some cells failed to evaluate."),Promise.resolve(oa);case 2:return Promise.reject("Calc estimation or model update failed");default:return Promise.reject("Calc estimation failed")}})}x2h(O,
ea,R,oa){const pa=this.cRd;this.ufj();const Pa=R.suggestion;this.CB&&Object(f.f)("USERINPUTARRIVED",Pa.ui,oa);this.cYd(Pa.range,!1);this.VJ.hide();T.a(()=>{this.CB&&Object(f.f)("PREVIEWREMOVEDWITHCSE",Pa.ui,oa);const Z={["flowId"]:Pa.ui,["originalFlowId"]:Pa.dca.ui,["caller"]:ea.Rue,["formulaAnonymized"]:Pa.anonymizedFormula,["originalFormulaAnonymized"]:Pa.dca.anonymizedFormula,["suggestionOutcome"]:ea.rpc,["annotationRange"]:Pa.range.toString(),["isFullyInViewport"]:this.gridView.nK(Pa.range),["isCachedSuggestion"]:oa,
["showFormulaClicked"]:pa,["exampleCount"]:Pa.WE,["originalExampleCount"]:Pa.dca.WE,["seenCount"]:R.pJb,["previewCellsMetadata"]:O.qpc,["previewShownDurations"]:this.CB?Object(f.e)(oa,Pa.ui):"none",["previewRemovedDurations"]:this.CB?Object(f.d)(oa,Pa.ui):"none"};d.ULS.sendTraceTag(388780100,306,50,`FormulaByExampleManager.handlePreviewResult: FormulaByExample flow results: ${JSON.stringify(Z)}`);Object(f.c)(Pa.ui)},this.$.la);d.ULS.sendTraceTag(523842074,306,50,`FormulaByExampleManager.handlePreviewResult: User ${ea.rpc} the formula via ${ea.Rue}`);
R.state=ea.rpc;R.Q7h();"ACCEPT"===ea.rpc&&this.vVc(Pa,O.nZc);this.$.userOperationManager.Co(this.Ymc)}ufj(){this.hMa=!1;this.JDd=null;this.cRd=!1}vVc(O,ea){const R=Object(b.a)(new D.a,{Text:O.formula});this.gridView.setCell(R,O.originCell,1,127,null,0,O.range,2);this.gkc.dKg(ea,O.formula);d.ULS.sendTraceTag(537161883,306,50,`FormulaByExampleManager.applyFormulaSuggestionOnRange: applied formula on table, range: ${O.range}`);this.rAd=(oa,pa)=>{0==pa.Lq&&(170==pa.xf.operation.operationName&&this.gMi(O.ui,
O.dca.ui),this.HOf())};this.$.userOperationManager.Hr(this.rAd)}Y1f(O){const ea=O.suggestion;return this.Pei(O.suggestion.ui)?O.state===I.decline?(this.VJ.uda(O.suggestion.originCell,6,W.a.ljg),d.ULS.sendTraceTag(528758217,306,50,`FormulaByExampleManager.shouldShowPreview: user declined this suggestion before, not showing again. flowId: ${ea.ui}`),{value:!1,reason:"User declined this suggestion before."}):O.state===I.ignore&&2<=O.pJb?(this.VJ.uda(O.suggestion.originCell,6,W.a.kjg),d.ULS.sendTraceTag(528758216,
306,50,`FormulaByExampleManager.shouldShowPreview: user saw suggestion at least twice and ignored last time. not showing again. flowId: ${ea.ui}`),{value:!1,reason:"User saw suggestion at least twice and ignored last time"}):ea.WE<V.a?(this.VJ.uda(O.suggestion.originCell,6,W.a.Pig),d.ULS.sendTraceTag(528758215,306,50,`FormulaByExampleManager.shouldShowPreview: cached suggestion does not have enough examples. not showing preview. flowId: ${ea.ui}`),{value:!1,reason:"Cached suggestion does not have enough examples."}):
{value:!0}:(this.VJ.uda(O.suggestion.originCell,6,W.a.Ohg),{value:!1,reason:"Client state is not available for preview."})}cYd(O,ea){for(let oa=O.top;oa<=O.bottom;oa++)for(let pa=O.left;pa<=O.right;pa++){var R=k.Range.Uc(oa,pa);if(R=this.gridView.Vb(R))R.cell.D3f=ea&&!R.cell.NDd}}Pei(O){return this.unb?this.MDd?(d.ULS.sendTraceTag(528758218,306,50,`FormulaByExampleManager.shouldShowPreview: can't show preview again as preview already was shown for the current edit. flowId: ${O}`),!1):this.hMa?(d.ULS.sendTraceTag(527005664,
306,50,`FormulaByExampleManager.shouldShowPreview: can't show preview for this suggestion as preview is already showing. flowId: ${O}`),!1):this.gridView.eb?(d.ULS.sendTraceTag(524813027,306,50,`FormulaByExampleManager.shouldShowPreview: can't show preview for this suggestion as user is editing. flowId: ${O}`),!1):!0:(d.ULS.debugAssertTag(524940239,306,!1,`FormulaByExampleManager.shouldShowPreview: Not expected to be called when no proactive suggestions are enabled. flowId: ${O}`),!1)}}Object(t.a)(qa,
"FormulaByExampleManager",null,[723,2])},972:function(t,C,a){a.d(C,"a",function(){return 2})}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaDSEsNext.augmentationloop.js.map/860f85fd85ab1a487831c6b06cdd8b8b/EwaDSEsNext.augmentationloop.js.map